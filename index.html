<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#0a1628" />
<title>Kapework</title>
<style>
/* â”€â”€â”€ Reset & tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #0a1628;
  --surface:  #121e33;
  --surface2: #1a2a44;
  --border:   rgba(232,237,245,0.07);
  --border-h: rgba(232,237,245,0.14);
  --cyan:     #00e5cc;
  --cyan-dim: rgba(0,229,204,0.10);
  --text:     #e8edf5;
  --muted:    rgba(232,237,245,0.45);
  --success:  #4ade80;
  --danger:   #f87171;
}

html, body { min-height: 100%; background: var(--bg); color: var(--text); }
body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
a { color: inherit; text-decoration: none; }
button, select, textarea { font: inherit; }

/* â”€â”€â”€ Page shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page {
  max-width: 840px;
  margin: 0 auto;
  padding: 28px 20px 80px;
}

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.site-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 28px;
  margin-bottom: 28px;
  border-bottom: 1px solid var(--border);
}

.wordmark {
  display: flex;
  align-items: baseline;
  gap: 3px;
  cursor: default;
}
.wordmark-text {
  font-size: 1.3rem;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.wordmark-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--cyan);
  margin-left: 1px;
  margin-bottom: 2px;
  flex-shrink: 0;
}

/* â”€â”€â”€ Menu button + dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.menu-wrap {
  position: relative;
}

.menu-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--muted);
  width: 38px;
  height: 38px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  letter-spacing: 1px;
  transition: color 0.15s, border-color 0.15s;
  line-height: 1;
}
.menu-btn:hover { color: var(--text); border-color: var(--border-h); }
.menu-btn.open  { color: var(--cyan); border-color: var(--cyan); }

.dropdown {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  min-width: 200px;
  background: var(--surface);
  border: 1px solid var(--border-h);
  border-radius: 14px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  padding: 6px;
  z-index: 200;
  opacity: 0;
  transform: translateY(-6px) scale(0.97);
  pointer-events: none;
  transition: opacity 0.15s ease, transform 0.15s ease;
}
.dropdown.open {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}

.dropdown-section {
  padding: 4px 6px 2px;
}
.dropdown-label {
  font-size: 0.68rem;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  padding: 6px 8px 4px;
}
.dropdown-divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 4px 0;
}

.sort-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 6px 8px;
}
.sort-row span {
  font-size: 0.85rem;
  color: var(--muted);
}
select.inline-sort {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 26px 4px 8px;
  font-size: 0.82rem;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23e8edf5' stroke-opacity='.4' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
}
select.inline-sort:focus { outline: none; border-color: var(--cyan); }

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  color: var(--text);
  font-size: 0.88rem;
  padding: 9px 10px;
  border-radius: 9px;
  cursor: pointer;
  text-align: left;
  transition: background 0.12s;
}
.dropdown-item:hover { background: var(--surface2); }
.dropdown-item .di-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }

/* â”€â”€â”€ Game grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
  gap: 12px;
}

/* â”€â”€â”€ Game card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card-wrap {
  position: relative;
}

a.card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 22px 14px 14px;
  cursor: pointer;
  transition: border-color 0.18s, transform 0.18s, box-shadow 0.18s;
  position: relative;
  overflow: hidden;
  width: 100%;
}
a.card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 0%, var(--cyan-dim) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.25s;
  pointer-events: none;
}
a.card:hover { border-color: var(--border-h); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.3); }
a.card:hover::before { opacity: 1; }
a.card:active { transform: scale(0.97); }

.card-icon {
  font-size: 3rem;
  line-height: 1;
  user-select: none;
}

.card-name {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text);
  text-align: center;
  line-height: 1.2;
}

/* Like button â€” sits below name, not a nav trigger */
.card-like {
  display: flex;
  align-items: center;
  gap: 5px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 4px 10px;
  color: var(--muted);
  font-size: 0.78rem;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  margin-top: 2px;
  -webkit-tap-highlight-color: transparent;
}
.card-like:hover { color: var(--text); border-color: var(--border-h); }
.card-like.liked { color: var(--danger); border-color: rgba(248,113,113,0.35); background: rgba(248,113,113,0.07); }

/* â”€â”€â”€ Empty / error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.state-msg {
  grid-column: 1 / -1;
  padding: 48px 24px;
  text-align: center;
  color: var(--muted);
  font-size: 0.9rem;
}

/* â”€â”€â”€ Modal backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(10,22,40,0.75);
  backdrop-filter: blur(3px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}
.modal-backdrop.open { opacity: 1; pointer-events: all; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border-h);
  border-radius: 20px;
  width: 100%;
  max-width: 480px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  transform: translateY(12px);
  transition: transform 0.2s;
}
.modal-backdrop.open .modal { transform: translateY(0); }

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
}
.modal-title {
  font-size: 1rem;
  font-weight: 800;
}
.modal-close {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--muted);
  width: 32px; height: 32px;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s;
}
.modal-close:hover { color: var(--text); }
.modal-body { padding: 20px; }

/* â”€â”€â”€ Stats table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.stats-table th {
  text-align: left;
  color: var(--muted);
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 0 10px 10px 0;
  border-bottom: 1px solid var(--border);
}
.stats-table th:not(:first-child) { text-align: right; }
.stats-table td {
  padding: 10px 10px 10px 0;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
.stats-table tr:last-child td { border-bottom: none; }
.stats-table td:not(:first-child) { text-align: right; color: var(--muted); }
.stats-table .game-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}
.stats-table .game-emoji { font-size: 1.1rem; flex-shrink: 0; }
.stats-table .game-label { font-weight: 600; }
.stats-val { font-variant-numeric: tabular-nums; }

/* â”€â”€â”€ Feedback form (in modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feedback-sub {
  font-size: 0.83rem;
  color: var(--muted);
  margin-bottom: 14px;
  line-height: 1.5;
}
.feedback-attached {
  font-size: 0.78rem;
  color: var(--muted);
  margin-bottom: 10px;
}
.feedback-attached span { color: var(--cyan); font-weight: 600; }
textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  padding: 12px 14px;
  resize: vertical;
  min-height: 80px;
  font: inherit;
  font-size: 0.88rem;
  line-height: 1.5;
  transition: border-color 0.15s;
}
textarea::placeholder { color: var(--muted); }
textarea:focus { outline: none; border-color: var(--cyan); }
.feedback-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
  justify-content: flex-end;
}
.feedback-status { font-size: 0.82rem; flex: 1; }
.feedback-status.ok  { color: var(--success); }
.feedback-status.err { color: var(--danger); }
.btn-send {
  background: var(--cyan);
  color: #0a1628;
  font-weight: 700;
  font-size: 0.88rem;
  border: none;
  border-radius: 10px;
  padding: 10px 20px;
  cursor: pointer;
  transition: opacity 0.15s;
  white-space: nowrap;
}
.btn-send:hover   { opacity: 0.9; }
.btn-send:disabled { opacity: 0.4; cursor: default; }

/* â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.site-footer {
  margin-top: 64px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
  font-size: 0.75rem;
  color: var(--muted);
  text-align: center;
}
</style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <header class="site-header">
    <div class="wordmark">
      <span class="wordmark-text">Kapework</span>
      <div class="wordmark-dot"></div>
    </div>

    <div class="menu-wrap">
      <button class="menu-btn" id="menu-btn" aria-label="Menu" aria-expanded="false">Â·Â·Â·</button>
      <div class="dropdown" id="dropdown" role="menu">
        <div class="sort-row">
          <span>Sort</span>
          <select class="inline-sort" id="sort" aria-label="Sort games">
            <option value="newest">Newest</option>
            <option value="name">A â€“ Z</option>
            <option value="likes">Most liked</option>
            <option value="plays">Most played</option>
          </select>
        </div>
        <hr class="dropdown-divider" />
        <button class="dropdown-item" id="open-stats">
          <span class="di-icon">ğŸ“Š</span> Stats &amp; plays
        </button>
        <button class="dropdown-item" id="open-feedback">
          <span class="di-icon">ğŸ’¬</span> Send feedback
        </button>
      </div>
    </div>
  </header>

  <!-- Game grid -->
  <div id="grid" aria-live="polite"></div>

  <footer class="site-footer">Kapework &mdash; small games, big ideas</footer>
</div>

<!-- Stats modal -->
<div class="modal-backdrop" id="stats-modal" role="dialog" aria-modal="true" aria-labelledby="stats-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="stats-title">Stats &amp; plays</div>
      <button class="modal-close" id="stats-close" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <table class="stats-table" id="stats-table">
        <thead>
          <tr>
            <th>Game</th>
            <th>Plays</th>
            <th>Likes</th>
          </tr>
        </thead>
        <tbody id="stats-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Feedback modal -->
<div class="modal-backdrop" id="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="fb-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="fb-title">Quick feedback</div>
      <button class="modal-close" id="fb-close" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="feedback-sub">What's working? What could be better?</div>
      <div class="feedback-attached">About: <span id="fb-target">General</span></div>
      <textarea id="fb-message" rows="3" placeholder="Tell us anything â€” a bug, an idea, a reaction."></textarea>
      <div class="feedback-row">
        <span class="feedback-status" id="fb-status"></span>
        <button class="btn-send" id="fb-send">Send</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
'use strict';

/* â”€â”€â”€ Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SUPABASE_URL  = "https://fimsbfcvavpehryvvcho.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbXNiZmN2YXZwZWhyeXZ2Y2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTEwMDMsImV4cCI6MjA3MDk2NzAwM30.6uAm_bDPN9aetYaKWA7zCvS8XDEVhmKKxA7RA7YK4JQ";
let sb = null;

/* â”€â”€â”€ Local state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DID_KEY   = "kapework_did_v1";
const LIKED_KEY = "kapework_liked_by_me_v1";
const LAST_KEY  = "kapework_last_played_slug";

let deviceId = localStorage.getItem(DID_KEY);
if (!deviceId) {
  deviceId = crypto?.randomUUID?.() || String(Math.random()).slice(2);
  localStorage.setItem(DID_KEY, deviceId);
}
let likedByMe  = JSON.parse(localStorage.getItem(LIKED_KEY) || "{}");

let games      = [];
const bySlug   = new Map();
let likeCounts = new Map();
let playCounts = new Map();

/* â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const gridEl      = document.getElementById("grid");
const sortSel     = document.getElementById("sort");
const menuBtn     = document.getElementById("menu-btn");
const dropdown    = document.getElementById("dropdown");
const statsModal  = document.getElementById("stats-modal");
const statsTbody  = document.getElementById("stats-tbody");
const fbModal     = document.getElementById("feedback-modal");
const fbTarget    = document.getElementById("fb-target");
const fbMsg       = document.getElementById("fb-message");
const fbSend      = document.getElementById("fb-send");
const fbStatus    = document.getElementById("fb-status");

/* â”€â”€â”€ Dropdown menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleDropdown(force) {
  const open = force !== undefined ? force : !dropdown.classList.contains("open");
  dropdown.classList.toggle("open", open);
  menuBtn.classList.toggle("open", open);
  menuBtn.setAttribute("aria-expanded", String(open));
}

menuBtn.addEventListener("click", e => { e.stopPropagation(); toggleDropdown(); });
document.addEventListener("click", () => toggleDropdown(false));
dropdown.addEventListener("click", e => e.stopPropagation());

/* â”€â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openModal(el) {
  el.classList.add("open");
  el.addEventListener("click", function onBd(e) {
    if (e.target === el) { closeModal(el); el.removeEventListener("click", onBd); }
  });
}
function closeModal(el) { el.classList.remove("open"); }

document.getElementById("open-stats").addEventListener("click", () => {
  toggleDropdown(false);
  renderStats();
  openModal(statsModal);
});
document.getElementById("stats-close").addEventListener("click", () => closeModal(statsModal));

document.getElementById("open-feedback").addEventListener("click", () => {
  toggleDropdown(false);
  refreshFbTarget();
  openModal(fbModal);
});
document.getElementById("fb-close").addEventListener("click", () => closeModal(fbModal));

document.addEventListener("keydown", e => {
  if (e.key === "Escape") { closeModal(statsModal); closeModal(fbModal); toggleDropdown(false); }
});

/* â”€â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadManifest() {
  try {
    const res  = await fetch("manifest.json?v=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("not array");
    games = data;
    games.forEach(g => bySlug.set(g.slug, g));
  } catch (e) {
    gridEl.innerHTML = `<div class="state-msg">Could not load games: ${e.message}</div>`;
  }
}

async function loadCounts() {
  if (!sb) return;
  try {
    const { data, error } = await sb.from("game_like_counts").select("slug,likes");
    if (!error && data) likeCounts = new Map(data.map(r => [r.slug, Number(r.likes) || 0]));
  } catch (_) {}
  try {
    const { data, error } = await sb.from("game_play_counts").select("slug,plays");
    if (!error && data) playCounts = new Map(data.map(r => [r.slug, Number(r.plays) || 0]));
  } catch (_) {}
}

/* â”€â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sortGames(list, mode) {
  if (mode === "name")  return [...list].sort((a, b) => a.name.localeCompare(b.name));
  if (mode === "likes") return [...list].sort((a, b) => (likeCounts.get(b.slug) || 0) - (likeCounts.get(a.slug) || 0));
  if (mode === "plays") return [...list].sort((a, b) => (playCounts.get(b.slug) || 0) - (playCounts.get(a.slug) || 0));
  return [...list].sort((a, b) => new Date(b.released_at) - new Date(a.released_at));
}

/* â”€â”€â”€ Render grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function render() {
  gridEl.innerHTML = "";
  if (!games.length) {
    gridEl.innerHTML = `<div class="state-msg">No games yet.</div>`;
    return;
  }

  const sorted = sortGames(games, sortSel.value);

  sorted.forEach(g => {
    const liked   = !!likedByMe[g.slug];
    const likeNum = likeCounts.get(g.slug) ?? 0;

    const wrap = document.createElement("div");
    wrap.className = "card-wrap";

    const card = document.createElement("a");
    card.className = "card";
    card.href      = g.url;
    card.target    = "_blank";
    card.rel       = "noopener";
    card.setAttribute("aria-label", `Play ${g.name}`);
    card.innerHTML = `
      <div class="card-icon">${g.cover_emoji || "ğŸ®"}</div>
      <div class="card-name">${g.name}</div>
    `;

    const likeBtn = document.createElement("button");
    likeBtn.type      = "button";
    likeBtn.className = "card-like" + (liked ? " liked" : "");
    likeBtn.setAttribute("aria-pressed", String(liked));
    likeBtn.setAttribute("aria-label",   `Like ${g.name}`);
    likeBtn.dataset.slug = g.slug;
    likeBtn.innerHTML = `<span class="lheart">${liked ? "â¤ï¸" : "â™¡"}</span><span class="lnum">${likeNum || ""}</span>`;

    card.appendChild(likeBtn);
    wrap.appendChild(card);
    gridEl.appendChild(wrap);

    /* Track play on navigation */
    card.addEventListener("click", e => {
      if (e.target.closest(".card-like")) return; // like button handles its own click
      recordPlay(g.slug);
    });

    /* Like */
    likeBtn.addEventListener("click", e => {
      e.preventDefault();
      e.stopPropagation();
      if (likedByMe[g.slug]) return;
      recordLike(g.slug, likeBtn);
    });
  });
}

/* â”€â”€â”€ Play tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function recordPlay(slug) {
  localStorage.setItem(LAST_KEY, slug);
  // Optimistic local increment
  playCounts.set(slug, (playCounts.get(slug) || 0) + 1);
  if (sortSel.value === "plays") setTimeout(render, 0);

  if (!sb) return;
  // Use SDK â€” handles auth headers reliably
  sb.from("plays")
    .insert({ slug, device_id: deviceId })
    .then(({ error }) => {
      if (error) console.warn("[kapework] play insert failed:", error.message);
    });
}

/* â”€â”€â”€ Like tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function recordLike(slug, btn) {
  likedByMe[slug] = true;
  localStorage.setItem(LIKED_KEY, JSON.stringify(likedByMe));
  likeCounts.set(slug, (likeCounts.get(slug) || 0) + 1);

  btn.classList.add("liked");
  btn.setAttribute("aria-pressed", "true");
  btn.querySelector(".lheart").textContent = "â¤ï¸";
  btn.querySelector(".lnum").textContent   = likeCounts.get(slug) || "";
  if (sortSel.value === "likes") render();

  if (!sb) return;
  sb.from("likes")
    .insert({ slug, device_id: deviceId })
    .then(({ error }) => {
      if (error) console.warn("[kapework] like insert failed:", error.message);
    });
}

/* â”€â”€â”€ Stats modal render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStats() {
  const sorted = sortGames(games, "plays");
  statsTbody.innerHTML = sorted.map(g => {
    const plays = playCounts.get(g.slug) ?? 0;
    const likes = likeCounts.get(g.slug) ?? 0;
    return `<tr>
      <td><div class="game-cell">
        <span class="game-emoji">${g.cover_emoji || "ğŸ®"}</span>
        <span class="game-label">${g.name}</span>
      </div></td>
      <td class="stats-val">${plays.toLocaleString()}</td>
      <td class="stats-val">${likes.toLocaleString()}</td>
    </tr>`;
  }).join("");
}

/* â”€â”€â”€ Feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function refreshFbTarget() {
  const last = localStorage.getItem(LAST_KEY);
  fbTarget.textContent = (last && bySlug.has(last)) ? bySlug.get(last).name : "General";
}

fbSend.addEventListener("click", async () => {
  const message = fbMsg.value.trim();
  if (!message) {
    fbStatus.textContent = "Please write something first.";
    fbStatus.className   = "feedback-status err";
    return;
  }
  if (!sb) {
    fbStatus.textContent = "Feedback unavailable â€” please reload.";
    fbStatus.className   = "feedback-status err";
    return;
  }

  const last = localStorage.getItem(LAST_KEY);
  const slug = (last && bySlug.has(last)) ? last : "general";

  fbSend.disabled      = true;
  fbStatus.textContent = "Sendingâ€¦";
  fbStatus.className   = "feedback-status";

  const { error } = await sb.from("feedback").insert({ slug, message });
  if (error) {
    fbStatus.textContent = "Could not send â€” please try again.";
    fbStatus.className   = "feedback-status err";
  } else {
    fbStatus.textContent = "Sent! Thank you.";
    fbStatus.className   = "feedback-status ok";
    fbMsg.value = "";
  }
  fbSend.disabled = false;
});

/* â”€â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
sortSel.addEventListener("change", render);

/* â”€â”€â”€ Visibility refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener("visibilitychange", async () => {
  if (!document.hidden) { await loadCounts(); render(); refreshFbTarget(); }
});

/* â”€â”€â”€ DB self-test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function dbSelfTest() {
  if (!sb) { console.warn("[kapework] âš ï¸  Supabase client not initialised"); return; }
  console.group("[kapework] DB self-test");

  // Test SELECT on each resource
  for (const tbl of ["plays","likes","game_play_counts","game_like_counts","feedback"]) {
    const { error } = await sb.from(tbl).select("*", { head: true, count: "exact" });
    if (error) console.warn(`  âœ— ${tbl}: ${error.message} (code ${error.code})`);
    else       console.log(`  âœ“ ${tbl}: readable`);
  }

  // Test INSERT into plays (canary row)
  const { error: plErr } = await sb.from("plays").insert({ slug: "__test__", device_id: "self-test" });
  if (plErr) console.warn(`  âœ— plays INSERT: ${plErr.message} (code ${plErr.code})`);
  else       console.log("  âœ“ plays INSERT: ok");

  // Test INSERT into likes (canary row)
  const { error: liErr } = await sb.from("likes").insert({ slug: "__test__", device_id: "self-test" });
  if (liErr) console.warn(`  âœ— likes INSERT: ${liErr.message} (code ${liErr.code})`);
  else       console.log("  âœ“ likes INSERT: ok");

  console.groupEnd();

  // Show brief on-screen toast if plays or likes insert failed
  if (plErr || liErr) {
    const t = Object.assign(document.createElement("div"), {
      textContent: "âš ï¸ Database not connected â€” plays & likes won't save. See console for details.",
    });
    Object.assign(t.style, {
      position:"fixed", bottom:"20px", left:"50%", transform:"translateX(-50%)",
      background:"#1a2a44", border:"1px solid rgba(248,113,113,0.4)", borderRadius:"12px",
      color:"#f87171", fontSize:"0.8rem", padding:"10px 18px", zIndex:"9999",
      boxShadow:"0 8px 32px rgba(0,0,0,0.5)", maxWidth:"90vw", textAlign:"center",
    });
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 9000);
  }
}

/* â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener("load", async () => {
  try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch (e) {}
  await loadManifest();
  await loadCounts();
  render();
  dbSelfTest(); // async, non-blocking â€” check console for results
});
</script>
</body>
</html>
