<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kapework Arcade</title>
<style>
  :root { --bd:#e5e7eb; --muted:#6b7280; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .sorter{display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px}
  .card{position:relative;border:1px solid var(--bd);border-radius:16px;padding:14px 14px 42px;box-shadow:0 1px 3px rgba(0,0,0,.05);cursor:pointer;background:#fff}
  .title{display:flex;gap:10px;align-items:center}
  .emoji{font-size:1.3rem}
  .name{font-weight:700}
  .badge{position:absolute;bottom:10px;border:1px solid var(--bd);border-radius:12px;padding:6px 10px;background:#fff}
  .playbadge{left:10px}
  .like{right:10px}
  .like.liked{background:#f9fafb}
  .feedback{margin-top:32px;border-top:1px solid var(--bd);padding-top:16px;display:grid;gap:10px}
  textarea,button,select{font:inherit}
  textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
  .ok{color:#065f46}
  .err{color:#7f1d1d}
</style>
</head>
<body>
  <header>
    <h1>Kapework Arcade</h1>
    <div class="sorter">
      <label for="sort">Sort:</label>
      <select id="sort" aria-label="Sort games">
        <option value="newest">Newest</option>
        <option value="name">Name (A‚ÄìZ)</option>
        <option value="likes">Most Liked</option>
        <option value="plays">Most Played</option>
      </select>
    </div>
  </header>

  <div id="grid" class="grid" aria-live="polite"></div>

  <section class="feedback">
    <h2>Quick feedback</h2>
    <div class="meta">Attached to: <span id="fb-target">General</span></div>
    <textarea id="fb-message" rows="3" placeholder="Tell me anything you liked or what to improve. (We‚Äôll tag it to the last game you played.)"></textarea>
    <div style="display:flex;justify-content:flex-end">
      <button id="fb-send">Send</button>
    </div>
    <p id="fb-status" class="meta"></p>
  </section>

  <!-- Supabase first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase project (anon/public) ===
    const SUPABASE_URL  = "https://fimsbfcvavpehryvvcho.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbXNiZmN2YXZwZWhyeXZ2Y2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTEwMDMsImV4cCI6MjA3MDk2NzAwM30.6uAm_bDPN9aetYaKWA7zCvS8XDEVhmKKxA7RA7YK4JQ";
    let sb = null;

    // DOM
    const grid = document.getElementById("grid");
    const sortSel = document.getElementById("sort");
    const fbMsg = document.getElementById("fb-message");
    const fbSend = document.getElementById("fb-send");
    const fbStatus = document.getElementById("fb-status");
    const fbTarget = document.getElementById("fb-target");

    // Local keys
    const DID_KEY   = "kapework_did_v1";
    const LIKED_KEY = "kapework_liked_by_me_v1";
    const LAST_KEY  = "kapework_last_played_slug";

    // Device id + local liked
    let deviceId = localStorage.getItem(DID_KEY);
    if (!deviceId) { deviceId = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); localStorage.setItem(DID_KEY, deviceId); }
    let likedByMe = JSON.parse(localStorage.getItem(LIKED_KEY) || "{}");

    // Data
    let games = [];
    const bySlug = new Map();
    let likeCounts = new Map(); // slug->int
    let playCounts = new Map(); // slug->int

    function showError(msg){
      const p=document.createElement("p"); p.className="meta err"; p.textContent=msg; grid.appendChild(p);
    }

    async function loadManifest(){
      try{
        const res = await fetch("manifest.json?v=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("JSON not array");
        games = data; games.forEach(g => bySlug.set(g.slug,g));
      }catch(e){ showError("Could not load manifest.json: " + (e.message||e)); games=[]; }
    }

    async function loadCounts(){
      if (!sb) return;
      try{
        const { data } = await sb.from("game_like_counts").select();
        if (data) likeCounts = new Map(data.map(r=>[r.slug, r.likes]));
      }catch(_){}
      try{
        const { data } = await sb.from("game_play_counts").select();
        if (data) playCounts = new Map(data.map(r=>[r.slug, r.plays]));
      }catch(_){}
    }

    function sortGames(list, mode){
      if (mode === "name")  return [...list].sort((a,b)=>a.name.localeCompare(b.name));
      if (mode === "likes") return [...list].sort((a,b)=>(likeCounts.get(b.slug)||0)-(likeCounts.get(a.slug)||0));
      if (mode === "plays") return [...list].sort((a,b)=>(playCounts.get(b.slug)||0)-(playCounts.get(a.slug)||0));
      return [...list].sort((a,b)=>new Date(b.released_at)-new Date(a.released_at)); // newest
    }

    function render(){
      grid.innerHTML="";
      const sorted = sortGames(games, sortSel.value);
      sorted.forEach(g=>{
        const liked = !!likedByMe[g.slug];
        const likeNum = likeCounts.get(g.slug) ?? 0;
        const playNum = playCounts.get(g.slug) ?? 0;

        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");
        card.innerHTML = `
          <div class="title">
            <span class="emoji">${g.cover_emoji || "üéÆ"}</span>
            <div class="name">${g.name}</div>
          </div>
          <span class="badge playbadge" data-slug="${g.slug}">‚ñ∂Ô∏é ${playNum}</span>
          <button class="badge like ${liked?"liked":""}" data-slug="${g.slug}" aria-pressed="${liked}">
            ${liked ? "‚ù§Ô∏è" : "‚ô°"} ${likeNum}
          </button>
        `;

        // Open game on card click (do navigation FIRST for iOS popup rules)
        card.addEventListener("click",(e)=>{
          if (e.target.closest("button.like")) return; // ignore heart clicks

          const slug = g.slug;
          const url  = g.url;

          // 1) Navigate immediately (try new tab, fall back to same tab)
          let opened = false;
          try { const w = window.open(url, "_blank"); opened = !!w; } catch(_) {}
          if (!opened) window.location.href = url;

          // 2) Update local UI counts (so the list feels instant)
          playCounts.set(slug, (playCounts.get(slug)||0) + 1);
          const badge = card.querySelector(".playbadge");
          if (badge) badge.textContent = `‚ñ∂Ô∏é ${playCounts.get(slug)}`;
          if (sortSel.value === "plays") render();

          // 3) Tag feedback + write play server-side (non-blocking)
          localStorage.setItem(LAST_KEY, slug);
          refreshAttachLabel();
          if (sb) { sb.from("plays").insert({ slug, device_id: deviceId }).catch(()=>{}); }
        });

        // Keyboard accessibility
        card.addEventListener("keydown",(e)=>{
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); card.click(); }
        });

        grid.appendChild(card);
      });

      // Heart buttons
      grid.querySelectorAll("button.like").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          const slug = e.currentTarget.dataset.slug;
          if (likedByMe[slug]) return;
          likedByMe[slug] = true;
          localStorage.setItem(LIKED_KEY, JSON.stringify(likedByMe));
          likeCounts.set(slug, (likeCounts.get(slug)||0) + 1);
          e.currentTarget.classList.add("liked");
          e.currentTarget.setAttribute("aria-pressed","true");
          e.currentTarget.textContent = `‚ù§Ô∏è ${likeCounts.get(slug)}`;
          if (sortSel.value === "likes") render();

          if (sb){
            try { await sb.from("likes").insert({ slug, device_id: deviceId }); }
            catch(err){ console.warn("Like insert failed:", err?.message||err); }
          }
        });
      });
    }

    function refreshAttachLabel(){
      const last = localStorage.getItem(LAST_KEY);
      fbTarget.textContent = (last && bySlug.has(last)) ? `${bySlug.get(last).name} (last played)` : "General";
    }

    async function sendFeedback(){
      const message = fbMsg.value.trim();
      if (!message) { fbStatus.textContent="Please write a quick note."; fbStatus.className="meta err"; return; }
      if (!sb) { fbStatus.textContent="Feedback service not ready. Reload and try again."; fbStatus.className="meta err"; return; }
      const last = localStorage.getItem(LAST_KEY);
      const slug = (last && bySlug.has(last)) ? last : "general";

      fbSend.disabled = true; fbStatus.textContent="Sending‚Ä¶"; fbStatus.className="meta";
      const { error } = await sb.from("feedback").insert({ slug, message });
      if (error) { fbStatus.textContent="Could not send, please try again."; fbStatus.className="meta err"; }
      else { fbStatus.textContent="Thank you! Saved."; fbStatus.className="meta ok"; fbMsg.value=""; }
      fbSend.disabled = false;
    }

    sortSel.addEventListener("change", render);
    fbSend.addEventListener("click", sendFeedback);

    window.addEventListener("load", async ()=>{
      try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) {}
      await loadManifest();
      await loadCounts();
      render();
      refreshAttachLabel();
    });
  </script>
</body>
</html>
