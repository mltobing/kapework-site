<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kapework Arcade</title>
<style>
  :root { --bd:#e5e7eb; --muted:#6b7280; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .sorter{display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:16px}
  .card{border:1px solid var(--bd);border-radius:14px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:8px}
  .title{display:flex;gap:8px;align-items:center;font-weight:600}
  .meta{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  a.play{text-decoration:none}
  button.like{border:1px solid var(--bd);border-radius:12px;padding:6px 10px;background:#fff;cursor:pointer}
  button.like.liked{background:#f9fafb}
  form#feedback{margin-top:32px;border-top:1px solid var(--bd);padding-top:16px;display:grid;gap:8px}
  input,select,textarea,button{font:inherit}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
</style>
</head>
<body>
  <header>
    <h1>Kapework Arcade</h1>
    <div class="sorter">
      <label for="sort">Sort:</label>
      <select id="sort">
        <option value="newest">Newest</option>
        <option value="name">Name (A‚ÄìZ)</option>
        <option value="liked">Liked (on this device)</option>
      </select>
    </div>
  </header>

  <div id="grid" class="grid" aria-live="polite"></div>

  <form id="feedback">
    <h2>Feedback</h2>
    <label>Game
      <select id="fb-game"></select>
    </label>
    <label>Your thoughts
      <textarea id="fb-message" rows="3" placeholder="What did you like? What should improve?"></textarea>
    </label>
    <button type="submit">Send feedback</button>
    <p id="fb-status" class="meta"></p>
  </form>

<script>
  // üëá SET THIS to your email for feedback:
  const FEEDBACK_EMAIL = "you@example.com";

  const grid = document.getElementById("grid");
  const sortSel = document.getElementById("sort");
  const fbGame = document.getElementById("fb-game");
  const fbForm = document.getElementById("feedback");
  const fbStatus = document.getElementById("fb-status");

  const LIKES_KEY = "kapework_likes_v1"; // { slug: true }
  let liked = JSON.parse(localStorage.getItem(LIKES_KEY) || "{}");
  let games = [];

  async function loadManifest(){
    const res = await fetch("manifest.json");
    games = await res.json();
    render();
  }

  function sortGames(list, mode){
    if (mode === "name") return [...list].sort((a,b)=>a.name.localeCompare(b.name));
    if (mode === "liked") return [...list].sort((a,b)=>{
      const A = liked[a.slug] ? 1 : 0, B = liked[b.slug] ? 1 : 0;
      if (B !== A) return B - A; // liked first
      return new Date(b.released_at) - new Date(a.released_at); // then newest
    });
    // default newest
    return [...list].sort((a,b)=>new Date(b.released_at) - new Date(a.released_at));
  }

  function render(){
    grid.innerHTML = "";
    fbGame.innerHTML = "";
    const sorted = sortGames(games, sortSel.value);

    sorted.forEach(g=>{
      const card = document.createElement("div");
      card.className = "card";
      const isLiked = !!liked[g.slug];
      card.innerHTML = `
        <div class="title"><span style="font-size:1.25rem">${g.cover_emoji||"üéÆ"}</span> ${g.name}</div>
        <div class="meta">${new Date(g.released_at).toLocaleDateString()} ¬∑ ${(g.tags||[]).join(" ¬∑ ")}</div>
        <p>${g.blurb||""}</p>
        <div class="row">
          <a class="play" href="${g.url}" target="_blank" rel="noopener">Play ‚ñ∂Ô∏è</a>
          <button class="like ${isLiked?"liked":""}" data-slug="${g.slug}">${isLiked?"‚ù§Ô∏è Liked":"‚ô° Like"}</button>
        </div>
      `;
      grid.appendChild(card);

      const opt = document.createElement("option");
      opt.value = g.slug; opt.textContent = g.name;
      fbGame.appendChild(opt);
    });

    grid.querySelectorAll("button.like").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        const slug = e.currentTarget.dataset.slug;
        liked[slug] = true;
        localStorage.setItem(LIKES_KEY, JSON.stringify(liked));
        e.currentTarget.classList.add("liked");
        e.currentTarget.textContent = "‚ù§Ô∏è Liked";
        render(); // re-sort if "Liked" selected
      });
    });
  }

  sortSel.addEventListener("change", render);

  fbForm.addEventListener("submit",(e)=>{
    e.preventDefault();
    const slug = fbGame.value;
    const game = games.find(g=>g.slug===slug);
    const msg = document.getElementById("fb-message").value.trim();
    if (!msg) { fbStatus.textContent = "Please write a quick note."; return; }
    const subject = encodeURIComponent(`Kapework feedback: ${game?.name||slug}`);
    const body = encodeURIComponent(msg);
    window.location.href = `mailto:${FEEDBACK_EMAIL}?subject=${subject}&body=${body}`;
    fbStatus.textContent = "Your email app should open‚Äîthank you!";
    fbForm.reset();
  });

  loadManifest();
</script>
</body>
</html>