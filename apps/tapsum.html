<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TapSum</title>
<style>
  :root { --bg:#0b1220; --panel:#121a2c; --ink:#e8eefc; --muted:#93a3c9; --bd:rgba(255,255,255,.08); --accent:#7dd3fc; --ok:#34d399; --err:#fb7185; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:520px;margin:0 auto;padding:16px 16px 24px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:20px}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:12px}
  .target{display:flex;flex-direction:column;align-items:center;gap:6px;margin:10px 0 6px}
  .label{font-size:12px;color:var(--muted)}
  .target .num{font-size:48px;font-weight:800;letter-spacing:.5px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0 8px}
  .cell{height:100px;border-radius:16px;border:1px solid var(--bd);background:rgba(255,255,255,.02);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;cursor:pointer;user-select:none;transition:transform .06s ease, background .06s}
  .cell:active{transform:scale(.98)}
  .cell.sel{outline:2px solid var(--accent);background:rgba(125,211,252,.12)}
  .sumrow{display:flex;justify-content:center;gap:10px;margin:6px 0 2px;color:var(--muted)}
  .sumrow .v{min-width:2ch;text-align:right;color:var(--ink)}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
  button{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:var(--ink);cursor:pointer;font:inherit}
  button:hover{background:#0f1a2f}
  .toast{height:22px;text-align:center;font-size:14px;color:var(--muted);margin-top:8px}
  .toast.ok{color:var(--ok)} .toast.err{color:var(--err)}
  @media (min-width:520px){ .cell{height:120px} }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>TapSum</h1></header>

  <div class="panel">
    <div class="target">
      <div class="label">Target</div>
      <div id="target" class="num">12</div>
    </div>

    <div id="grid" class="grid" role="group" aria-label="number grid"></div>

    <div class="sumrow">
      <span class="label">Sum</span>
      <span id="sum" class="v">0</span>
    </div>

    <div class="actions">
      <button id="restart" title="Clear picks (Esc / Enter)">Restart</button>
      <button id="new" title="New round (Enter after win)">New</button>
    </div>

    <div id="toast" class="toast" aria-live="polite"></div>
  </div>

  <p class="label" style="margin:10px 4px 0">
    Keyboard: <strong>1–9</strong> select, <strong>Backspace</strong> undo, <strong>Esc</strong> clear, <strong>Enter</strong> new.
  </p>
</div>

<script>
(function(){
  const gridEl = document.getElementById('grid');
  const targetEl = document.getElementById('target');
  const sumEl = document.getElementById('sum');
  const restartBtn = document.getElementById('restart');
  const newBtn = document.getElementById('new');
  const toast = document.getElementById('toast');

  // --- Game state ---
  let cells = [];          // [{el,val,selected,usedIdx}] length 9
  let picks = [];          // indices of selected cells
  let target = 0;
  let won = false;

  // Utility
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function genRound(){
    won = false;
    toast.textContent = "";
    picks = [];
    sumEl.textContent = "0";

    // Create a guaranteed-solvable target by picking 2-4 random numbers up front
    const must = [];
    const count = rand(2,4);
    for (let i=0;i<count;i++) must.push(rand(1,9));
    target = must.reduce((a,b)=>a+b,0);
    targetEl.textContent = String(target);

    // Fill 9 cells, place the "must" set somewhere, rest random 1-9
    const vals = [];
    for (let i=0;i<9;i++) vals.push(rand(1,9));
    // overwrite random positions with the must picks
    const slots = [...Array(9).keys()].sort(()=>Math.random()-0.5).slice(0,must.length);
    slots.forEach((pos,i)=>{ vals[pos]=must[i]; });

    // build DOM
    gridEl.innerHTML = "";
    cells = vals.map((v,idx)=>{
      const el = document.createElement('div');
      el.className = 'cell';
      el.textContent = v;
      el.setAttribute('role','button');
      el.setAttribute('tabindex','0');
      el.setAttribute('aria-label', `Pick ${v}`);
      el.addEventListener('click', ()=>toggle(idx));
      el.addEventListener('keydown', e=>{
        if (e.key==='Enter' || e.key===' ') { e.preventDefault(); toggle(idx); }
      });
      gridEl.appendChild(el);
      return { el, val:v, selected:false };
    });
  }

  function updateSum(){
    const s = picks.reduce((a,i)=>a+cells[i].val,0);
    sumEl.textContent = String(s);
    return s;
  }

  function toggle(i){
    if (won) return;
    const c = cells[i];
    c.selected = !c.selected;
    if (c.selected){ picks.push(i); c.el.classList.add('sel'); }
    else { picks = picks.filter(x=>x!==i); c.el.classList.remove('sel'); }
    const s = updateSum();
    if (s === target){
      won = true;
      toast.textContent = "Nice! Starting a new round…";
      toast.className = "toast ok";
      setTimeout(genRound, 1000);
    } else if (s > target){
      toast.textContent = "Too high – undo or restart.";
      toast.className = "toast err";
    } else {
      toast.textContent = "";
      toast.className = "toast";
    }
  }

  // Keyboard: digits pick a tile with that value (cycles through duplicates)
  const lastHitByVal = {}; // value -> last index hit
  function pickByDigit(d){
    const val = d;
    const start = (lastHitByVal[val] ?? -1) + 1;
    // search for next unused cell with this value
    const order = [...Array(9).keys()];
    const perm = order.slice(start).concat(order.slice(0,start));
    for (const i of perm){
      if (cells[i].val === val) {
        lastHitByVal[val] = i;
        toggle(i);
        return;
      }
    }
    // no match—blink toast
    toast.textContent = `No ${val} available.`;
    toast.className = "toast err";
    setTimeout(()=>{ toast.textContent = ""; toast.className="toast"; }, 500);
  }

  // Controls
  restartBtn.addEventListener('click', ()=>{
    if (won) { genRound(); return; }
    picks.forEach(i=>cells[i].el.classList.remove('sel'));
    cells.forEach(c=>c.selected=false);
    picks = [];
    toast.textContent = "";
    toast.className = "toast";
    updateSum();
  });

  newBtn.addEventListener('click', genRound);

  window.addEventListener('keydown', (e)=>{
    if (e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
    if (e.key>='1' && e.key<='9'){ pickByDigit(parseInt(e.key,10)); return; }
    if (e.key==='Backspace' || e.key==='Delete'){
      const i = picks.pop();
      if (i!=null){ cells[i].selected=false; cells[i].el.classList.remove('sel'); updateSum(); }
      e.preventDefault(); return;
    }
    if (e.key==='Escape'){ restartBtn.click(); }
    if (e.key==='Enter'){ if (won) newBtn.click(); else restartBtn.click(); }
  });

  genRound();
})();
</script>
</body>
</html>
