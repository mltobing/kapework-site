<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TapSum</title>
<style>
  :root {
    --bg:#0b1220; --panel:#121a2c; --ink:#e8eefc; --muted:#93a3c9; --bd:rgba(255,255,255,.08);
    --accent:#7dd3fc; --ok:#34d399; --err:#fb7185;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:560px;margin:0 auto;padding:16px 16px 24px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h1{margin:0;font-size:20px}
  .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#0e1729}
  .pill strong{font-weight:800}
  .btn{padding:6px 10px;border-radius:10px;border:1px solid var(--bd);background:#0e1729;color:var(--ink);cursor:pointer}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:12px}
  .target{display:flex;flex-direction:column;align-items:center;gap:6px;margin:10px 0 6px}
  .label{font-size:12px;color:var(--muted)}
  .target .num{font-size:48px;font-weight:800;letter-spacing:.5px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0 8px}
  .cell{height:100px;border-radius:16px;border:1px solid var(--bd);background:rgba(255,255,255,.02);
        display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;cursor:pointer;user-select:none;transition:transform .06s ease, background .06s}
  .cell:active{transform:scale(.98)}
  .cell.sel{outline:2px solid var(--accent);background:rgba(125,211,252,.12)}
  .sumrow{display:flex;justify-content:center;gap:10px;margin:6px 0 2px;color:var(--muted)}
  .sumrow .v{min-width:2ch;text-align:right;color:var(--ink)}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
  button{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:var(--ink);cursor:pointer;font:inherit}
  button:hover{background:#0f1a2f}
  .toast{height:22px;text-align:center;font-size:14px;color:var(--muted);margin-top:8px}
  .toast.ok{color:var(--ok)} .toast.err{color:var(--err)}
  @media (min-width:560px){ .cell{height:120px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>TapSum</h1>
    <div class="stats">
      <span class="pill">Streak <strong id="streak">0</strong></span>
      <span class="pill">Best <strong id="best">0</strong></span>
      <span class="pill">Global <strong id="global">0</strong></span>
      <button id="ambience" class="btn" title="Ambient sound (calming pad)">ðŸŽ§</button>
    </div>
  </header>

  <div class="panel">
    <div class="target">
      <div class="label">Target</div>
      <div id="target" class="num">12</div>
    </div>

    <div id="grid" class="grid" role="group" aria-label="number grid"></div>

    <div class="sumrow">
      <span class="label">Sum</span>
      <span id="sum" class="v">0</span>
    </div>

    <div class="actions">
      <button id="restart" title="Clear picks (Esc / Enter)">Restart</button>
      <button id="new" title="New round (Enter after win)">New</button>
    </div>

    <div id="toast" class="toast" aria-live="polite"></div>
  </div>

  <p class="label" style="margin:10px 4px 0">
    Keyboard: <strong>1â€“9</strong> select, <strong>Backspace</strong> undo, <strong>Esc</strong> clear, <strong>Enter</strong> new.
  </p>
</div>

<!-- Supabase (for global best storage) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const SUPABASE_URL  = "https://fimsbfcvavpehryvvcho.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbXNiZmN2YXZwZWhyeXZ2Y2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTEwMDMsImV4cCI6MjA3MDk2NzAwM30.6uAm_bDPN9aetYaKWA7zCvS8XDEVhmKKxA7RA7YK4JQ";
  const SLUG = "tapsum";
  let sb = null;

  // --- DOM
  const gridEl = document.getElementById('grid');
  const targetEl = document.getElementById('target');
  const sumEl = document.getElementById('sum');
  const restartBtn = document.getElementById('restart');
  const newBtn = document.getElementById('new');
  const toast = document.getElementById('toast');
  const streakEl = document.getElementById('streak');
  const bestEl = document.getElementById('best');
  const globalEl = document.getElementById('global');
  const ambienceBtn = document.getElementById('ambience');

  // --- Device/local state
  const DID_KEY = "kapework_did_v1";
  const BEST_KEY = "tapsum_best_streak_v1";
  let deviceId = localStorage.getItem(DID_KEY);
  if (!deviceId) { deviceId = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); localStorage.setItem(DID_KEY, deviceId); }
  let bestLocal = parseInt(localStorage.getItem(BEST_KEY)||"0",10);
  bestEl.textContent = bestLocal;

  // --- Game state
  let cells = [];          // [{el,val,selected}]
  let picks = [];          // indices of selected cells
  let target = 0;
  let won = false;
  let streak = 0;
  let interacted = false;  // to decide if Restart/New should reset streak

  // --- Ambient sound (very soft pad; requires user tap)
  let ctx = null, gain=null, o1=null, o2=null, lfo=null;
  function toggleAmbience(){
    if (!ctx){
      ctx = new (window.AudioContext||window.webkitAudioContext)();
      gain = ctx.createGain(); gain.gain.value = 0.03; gain.connect(ctx.destination);
      o1 = ctx.createOscillator(); o1.type="sine"; o1.frequency.value=220; o1.detune.value=-6; o1.connect(gain); o1.start();
      o2 = ctx.createOscillator(); o2.type="sine"; o2.frequency.value=220; o2.detune.value=+6; o2.connect(gain); o2.start();
      lfo = ctx.createOscillator(); lfo.type="sine"; lfo.frequency.value=0.08;
      const lfoGain = ctx.createGain(); lfoGain.gain.value = 12; // gentle pitch drift
      lfo.connect(lfoGain); lfoGain.connect(o1.detune); lfoGain.connect(o2.detune); lfo.start();
      ambienceBtn.textContent = "ðŸŽ§ On";
    } else if (ctx.state === "running") {
      ctx.suspend(); ambienceBtn.textContent = "ðŸŽ§";
    } else {
      ctx.resume(); ambienceBtn.textContent = "ðŸŽ§ On";
    }
  }
  ambienceBtn.addEventListener('click', toggleAmbience);

  // --- Helpers
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  function updateStreak(v){ streak = v; streakEl.textContent = v; }

  function genRound(){
    won = false; interacted = false;
    toast.textContent = "";
    picks = []; sumEl.textContent = "0";

    // Build guaranteed-solvable target: pick 2-4 base numbers
    const must = Array.from({length:rand(2,4)}, ()=>rand(1,9));
    target = must.reduce((a,b)=>a+b,0);
    targetEl.textContent = String(target);

    // Fill grid, inject must
    const vals = Array.from({length:9}, ()=>rand(1,9));
    const slots = [...Array(9).keys()].sort(()=>Math.random()-0.5).slice(0,must.length);
    slots.forEach((pos,i)=>{ vals[pos]=must[i]; });

    // DOM rebuild
    gridEl.innerHTML = "";
    cells = vals.map((v,idx)=>{
      const el = document.createElement('div');
      el.className = 'cell'; el.textContent = v;
      el.setAttribute('role','button'); el.setAttribute('tabindex','0');
      el.addEventListener('click', ()=>{ interacted=true; toggle(idx); });
      el.addEventListener('keydown', e=>{
        if (e.key==='Enter' || e.key===' ') { e.preventDefault(); interacted=true; toggle(idx); }
      });
      gridEl.appendChild(el);
      return { el, val:v, selected:false };
    });
  }

  function updateSum(){
    const s = picks.reduce((a,i)=>a+cells[i].val,0);
    sumEl.textContent = String(s);
    return s;
  }

  async function onWin(){
    won = true;
    updateStreak(streak+1);
    toast.textContent = "Nice! Starting a new roundâ€¦";
    toast.className = "toast ok";

    // Personal best (local + cloud)
    if (streak > bestLocal){
      bestLocal = streak;
      localStorage.setItem(BEST_KEY, String(bestLocal));
      bestEl.textContent = bestLocal;
      // Upsert to Supabase
      try{
        if (!sb) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        await sb.from("scores").upsert(
          { slug: SLUG, device_id: deviceId, best_streak: bestLocal },
          { onConflict: "slug,device_id" }
        );
        refreshGlobal();
      }catch(e){ /* ignore */ }
    }
    setTimeout(genRound, 900);
  }

  function toggle(i){
    if (won) return;
    const c = cells[i];
    c.selected = !c.selected;
    if (c.selected){ picks.push(i); c.el.classList.add('sel'); }
    else { picks = picks.filter(x=>x!==i); c.el.classList.remove('sel'); }
    const s = updateSum();
    if (s === target){ onWin(); }
    else if (s > target){ toast.textContent = "Too high â€“ undo or restart."; toast.className = "toast err"; }
    else { toast.textContent = ""; toast.className = "toast"; }
  }

  // Digit selection with cycling
  const lastHitByVal = {};
  function pickByDigit(d){
    interacted = true;
    const val = d;
    const start = (lastHitByVal[val] ?? -1) + 1;
    const order = [...Array(9).keys()];
    const perm = order.slice(start).concat(order.slice(0,start));
    for (const i of perm){ if (cells[i].val === val){ lastHitByVal[val]=i; toggle(i); return; } }
    toast.textContent = `No ${val} available.`; toast.className = "toast err";
    setTimeout(()=>{ toast.textContent=""; toast.className="toast"; }, 400);
  }

  restartBtn.addEventListener('click', ()=>{
    if (!won && interacted) updateStreak(0); // break streak if you give up mid-round
    picks.forEach(i=>cells[i].el.classList.remove('sel'));
    cells.forEach(c=>c.selected=false); picks=[]; toast.textContent=""; toast.className="toast"; updateSum();
  });
  newBtn.addEventListener('click', ()=>{
    if (!won && interacted) updateStreak(0); // starting fresh mid-round breaks streak
    genRound();
  });

  window.addEventListener('keydown', (e)=>{
    if (e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
    if (e.key>='1' && e.key<='9'){ pickByDigit(parseInt(e.key,10)); return; }
    if (e.key==='Backspace' || e.key==='Delete'){
      interacted = true;
      const i = picks.pop();
      if (i!=null){ cells[i].selected=false; cells[i].el.classList.remove('sel'); updateSum(); }
      e.preventDefault(); return;
    }
    if (e.key==='Escape'){ restartBtn.click(); }
    if (e.key==='Enter'){ if (won) newBtn.click(); else restartBtn.click(); }
  });

  async function refreshGlobal(){
    try{
      if (!sb) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      const { data } = await sb.from("global_best_scores").select().eq("slug", SLUG).maybeSingle();
      globalEl.textContent = data?.global_best ?? 0;
    }catch(e){ /* ignore */ }
  }

  // init
  refreshGlobal();
  updateStreak(0);
  genRound();
})();
</script>
</body>
</html>