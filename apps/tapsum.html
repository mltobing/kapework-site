<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>TapSum</title>
  <style>
    /* --- Screen fit: paste near the top of <style> --- */
html,body{
  height:100svh;            /* iOS-safe full height */
  margin:0;
  overflow:hidden;          /* prevent accidental scroll */
  background:#f8f7f4;       /* neutral background */
  color:#2b221b;
  font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}
.wrap{
  height:100%;
  display:grid;             /* center content */
  place-items:center;
  padding:8px;
}
    :root{
      --bg:#0b0f14;
      --panel:#121923;
      --panel-2:#0f1620;
      --text:#f2f5f7;
      --muted:#9fb0c0;
      --accent:#2d81ff; /* selection */
      --good:#21c36a;   /* success */
      --bad:#ff715e;    /* strike */
      --warn:#f4d06f;   /* timer flash */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 50% -10%, #14202d, var(--bg));
      color:var(--text); display:flex; align-items:center; justify-content:center;
    }
    .app{width:100%; max-width:480px; padding:16px;}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid rgba(255,255,255,0.06); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:16px}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .topbar{margin-bottom:10px}
    .chip{background:#0e1520; color:var(--muted); border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:12px; font-size:14px; display:inline-flex; align-items:center; gap:6px}
    .chip button{background:transparent; border:none; color:inherit; font:inherit; padding:0; cursor:pointer}
    .mode{display:flex; gap:6px}
    .seg{border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.08)}
    .seg button{all:unset; padding:8px 12px; cursor:pointer; color:var(--muted); background:#0e1520}
    .seg button.active{background:var(--accent); color:white}
    .stats{display:flex; gap:8px; align-items:center}
    .stats .pill{padding:6px 10px; background:#0e1520; border-radius:999px; color:var(--muted); border:1px solid rgba(255,255,255,0.06)}
    .target{margin:8px 0 12px; text-align:center}
    .target .label{font-size:14px; color:var(--muted)}
    .target .num{font-size:54px; font-weight:800; letter-spacing:1px; margin-top:4px}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:12px 0}
    .cell{position:relative; aspect-ratio:1/1; border-radius:18px; background:#0e1622; border:1px solid rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:800; cursor:pointer; transition:transform .05s ease, background .15s ease, border-color .15s; color:#f8f8f8; text-shadow:0 1px 2px rgba(0,0,0,0.6)}
    .cell:active{transform:scale(.98)}
    .cell.selected{background:rgba(45,129,255,.15); border-color:var(--accent); box-shadow:inset 0 0 0 2px rgba(45,129,255,.5)}
    .cell.good{animation:pop .3s ease}
    .cell.bad{animation:shake .25s ease}

    @keyframes pop{0%{transform:scale(1)} 40%{transform:scale(1.05)} 100%{transform:scale(1)} }
    @keyframes shake{0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }

    .sum{display:flex; justify-content:center; gap:8px; align-items:center; color:var(--muted)}
    .sum .bubble{background:#0e1520; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); color:var(--text)}

    .controls{display:flex; gap:8px; margin-top:12px}
    .btn{all:unset; flex:1; text-align:center; padding:12px; border-radius:14px; cursor:pointer; background:#0e1520; border:1px solid rgba(255,255,255,0.08); color:var(--text); font-weight:600}
    .btn.secondary{color:var(--muted)}
    .btn.warn{background:#17202c}

    .footer{margin-top:14px; display:flex; gap:8px; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px}

    .hearts{letter-spacing:2px}
    .timer.low{color:var(--warn)}

    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#101821; color:var(--text); padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); opacity:0; pointer-events:none}
    .toast.show{opacity:1; animation:fade .9s ease}
    @keyframes fade{0%{opacity:0; transform:translateX(-50%) translateY(6px)} 15%,85%{opacity:1; transform:translateX(-50%) translateY(0)} 100%{opacity:0; transform:translateX(-50%) translateY(6px)}}

    .overlay{position:fixed; inset:0; display:none; background:rgba(3,8,14,.8); align-items:center; justify-content:center; padding:16px}
    .overlay .panel{max-width:480px; width:100%; background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid rgba(255,255,255,0.08); border-radius:20px; padding:18px}
    .overlay.show{display:flex}

    .emoji-log{font-size:22px; line-height:1.4; max-height:6lh; overflow:auto; padding:10px; background:#0e1520; border-radius:12px; border:1px solid rgba(255,255,255,0.06)}
    .muted{color:var(--muted)}
    a {color: var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="TapSum number tapping game">
    <div class="card">
      <div class="row topbar" aria-live="polite">
        <div class="mode">
          <div class="seg" role="tablist" aria-label="Game mode">
            <button id="btnDaily" class="active" role="tab" aria-selected="true">Daily</button>
            <button id="btnEndless" role="tab" aria-selected="false">Endless</button>
          </div>
        </div>
        <div class="stats">
          <div class="pill" id="timer" aria-label="Time remaining">60s</div>
          <div class="pill" id="score" aria-label="Score">0</div>
          <div class="pill hearts" id="hearts" aria-label="Strikes">‚ù§‚ù§‚ù§</div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between; gap:10px">
        <div class="chip" title="Sound">
          <button id="soundBtn" aria-label="Toggle sound">üîä</button>
          <span class="muted">Sound</span>
        </div>
        <div class="chip" title="Haptics">
          <button id="hapticBtn" aria-label="Toggle haptics">üì≥</button>
          <span class="muted">Haptics</span>
        </div>
        <div class="chip" title="Share score">
          <button id="shareBtn" aria-label="Share results">üì§</button>
          <span class="muted">Share</span>
        </div>
      </div>

      <div class="target" aria-live="polite">
        <div class="label">Target</div>
        <div class="num" id="targetNum">‚Äî</div>
      </div>

      <div class="grid" id="grid" role="grid" aria-label="Number grid"></div>

      <div class="sum" aria-live="polite">
        <span class="muted">Sum</span>
        <span class="bubble" id="sumNow">0</span>
      </div>

      <div class="controls">
        <button class="btn secondary" id="clearBtn" aria-label="Clear selection">Clear</button>
        <button class="btn" id="newBtn" aria-label="New round">New</button>
        <button class="btn warn" id="restartBtn" aria-label="Restart game">Restart</button>
      </div>

      <div class="footer">
        <span id="modeHint" class="muted">Daily seed: <span id="seedTxt"></span></span>
        <span id="bestTxt" class="muted">Best: ‚Äî</span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div id="gameOver" class="overlay" role="dialog" aria-modal="true" aria-labelledby="goTitle">
    <div class="panel">
      <h2 id="goTitle" style="margin:0 0 8px">Time!</h2>
      <div class="muted" id="goSummary" style="margin-bottom:10px"></div>
      <div class="emoji-log" id="emojiLog"></div>
      <div class="controls" style="margin-top:12px">
        <button class="btn" id="goShare">Share</button>
        <button class="btn warn" id="goAgain">Play Again</button>
      </div>
    </div>
  </div>

  <script>
  // --- seeded RNG helpers (xmur3 + mulberry32) ---
  function xmur3(str){
    for(var i=0,h=1779033703 ^ str.length; i<str.length; i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    return function(){
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      return (h ^= h >>> 16) >>> 0;
    };
  }
  function mulberry32(a){
    return function(){
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function rngFromSeed(seedStr){
    return mulberry32(xmur3(seedStr)());
  }

  // --- audio + haptics ---
  let audioCtx = null; let soundOn = true; let hapticsOn = true;
  function beep(freq=440, ms=80){
    if(!soundOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = freq;
      o.connect(g); g.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);
      o.start(now); o.stop(now + ms/1000 + 0.02);
    }catch(e){ /* ignore */ }
  }
  function vibrate(ms){ if(hapticsOn && navigator.vibrate) navigator.vibrate(ms); }

  // --- game state ---
  const el = (id)=>document.getElementById(id);
  const gridEl = el('grid');
  const targetEl = el('targetNum');
  const sumEl = el('sumNow');
  const timerEl = el('timer');
  const scoreEl = el('score');
  const heartsEl = el('hearts');
  const seedTxt = el('seedTxt');
  const bestTxt = el('bestTxt');
  const toast = el('toast');
  const overlay = el('gameOver');
  const emojiLogEl = el('emojiLog');
  const goSummary = el('goSummary');

  const LS = {
    BEST_SCORE: 'tapsum_best_score',
    BEST_STREAK: 'tapsum_best_streak',
    LAST_DAY: 'tapsum_last_day',
    DAILY_STREAK: 'tapsum_daily_streak',
  };

  let mode = 'daily';
  let rng = rngFromSeed(dayKey(new Date()));
  let score = 0; let strikes = 0; let timeLeft = 60; let tick = null;
  let selected = new Set();
  let cells = []; // {el, value}
  let target = 0;
  let roundCount = 0; // attempted rounds
  const emojiLog = []; // üü© success, üü• strike
  let bestScore = parseInt(localStorage.getItem(LS.BEST_SCORE) || '0',10);
  let bestStreak = parseInt(localStorage.getItem(LS.BEST_STREAK) || '0',10);

  // --- utils ---
  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function randInt(min, max){ // [min,max]
    const r = mode==='daily' ? rng() : Math.random();
    return Math.floor(r*(max-min+1)) + min;
  }
  function choice(arr){ return arr[randInt(0,arr.length-1)]; }
  function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 900); }
  function updateHUD(){
    scoreEl.textContent = score;
    heartsEl.textContent = '‚ù§‚ù§‚ù§'.slice(0, 3 - strikes) + '‚ô°'.repeat(strikes);
    if(timeLeft <= 10) timerEl.classList.add('low'); else timerEl.classList.remove('low');
    timerEl.textContent = timeLeft + 's';
    bestTxt.textContent = 'Best: ' + bestScore;
  }

  // --- grid/round generation ---
  function nextRound(){
    roundCount++;
    selected.clear();
    sumEl.textContent = '0';
    gridEl.innerHTML = '';

    // difficulty scales: early rounds k=2, later more 3; rare 4
    let k = 2;
    if(score >= 4 && score < 10) k = randInt(1,100) <= 70 ? 2 : 3; // mostly 2, some 3
    if(score >= 10) k = randInt(1,100) <= 40 ? 2 : 3; // more 3s later

    // create a guaranteed solution first
    const solution = [];
    for(let i=0;i<k;i++) solution.push(randInt(1,9));
    target = solution.reduce((a,b)=>a+b,0);

    // place solution digits into random distinct cells
    const indices = [...Array(9).keys()];
    const solIdx = [];
    for(let i=0;i<k;i++){
      const j = indices.splice(randInt(0, indices.length-1), 1)[0];
      solIdx.push(j);
    }
    const digits = new Array(9).fill(0);
    solIdx.forEach((idx,i)=> digits[idx] = solution[i]);
    for(let i=0;i<9;i++) if(digits[i]===0) digits[i] = randInt(1,9);

    targetEl.textContent = String(target);

    // build grid cells
    cells = digits.map((val, idx)=>{
      const c = document.createElement('button');
      c.className = 'cell';
      c.setAttribute('role','gridcell');
      c.setAttribute('aria-label',`Cell ${idx+1}, value ${val}`);
      c.textContent = val;
      c.addEventListener('click', ()=> toggle(idx));
      gridEl.appendChild(c);
      return {el:c, value:val};
    });
  }

  function toggle(idx){
    const cell = cells[idx];
    if(selected.has(idx)){
      selected.delete(idx);
      cell.el.classList.remove('selected');
      beep(260,45);
    } else {
      selected.add(idx);
      cell.el.classList.add('selected');
      beep(520,60);
    }
    const sum = currentSum();
    sumEl.textContent = String(sum);
    if(sum === target){
      // success
      success();
    } else if(sum > target){
      // bust
      bust();
    }
  }

  function currentSum(){
    let s = 0; selected.forEach(i => s += cells[i].value); return s;
  }

  function success(){
    beep(880,120); vibrate(25);
    score += 1; if(score > bestScore){ bestScore = score; localStorage.setItem(LS.BEST_SCORE, String(bestScore)); }
    cells.forEach(({el})=> el.classList.remove('selected'));
    emojiLog.push('üü©');
    updateHUD();
    // small highlight on target
    targetEl.style.color = 'var(--good)';
    setTimeout(()=>{ targetEl.style.color = 'var(--text)'; nextRound(); }, 180);
  }

  function bust(){
    beep(140,150); vibrate(50);
    strikes += 1; emojiLog.push('üü•');
    cells.forEach(({el})=> el.classList.remove('selected'));
    cells.forEach(({el})=>{ el.classList.add('bad'); setTimeout(()=> el.classList.remove('bad'), 200); });
    selected.clear(); sumEl.textContent = '0';
    updateHUD();
    if(strikes >= 3){ endGame(); }
  }

  // --- controls ---
  el('clearBtn').addEventListener('click', ()=>{ selected.forEach(i => cells[i].el.classList.remove('selected')); selected.clear(); sumEl.textContent = '0'; beep(200,50); });
  el('newBtn').addEventListener('click', ()=>{ nextRound(); beep(300,70); });
  el('restartBtn').addEventListener('click', ()=> startGame());

  document.getElementById('btnDaily').addEventListener('click', ()=> setMode('daily'));
  document.getElementById('btnEndless').addEventListener('click', ()=> setMode('endless'));

  el('soundBtn').addEventListener('click', ()=>{ soundOn = !soundOn; el('soundBtn').textContent = soundOn ? 'üîä' : 'üîá'; showToast('Sound ' + (soundOn?'on':'off')); });
  el('hapticBtn').addEventListener('click', ()=>{ hapticsOn = !hapticsOn; showToast('Haptics ' + (hapticsOn?'on':'off')); });

  el('shareBtn').addEventListener('click', shareNow);
  el('goShare').addEventListener('click', shareNow);
  el('goAgain').addEventListener('click', ()=>{ overlay.classList.remove('show'); startGame(); });

  function setMode(m){
    mode = m;
    document.getElementById('btnDaily').classList.toggle('active', m==='daily');
    document.getElementById('btnDaily').setAttribute('aria-selected', m==='daily');
    document.getElementById('btnEndless').classList.toggle('active', m==='endless');
    document.getElementById('btnEndless').setAttribute('aria-selected', m==='endless');
    showToast(m === 'daily' ? 'Daily mode' : 'Endless mode');
    startGame();
  }

  function startGame(){
    if(tick) clearInterval(tick);
    score = 0; strikes = 0; timeLeft = 60; roundCount = 0; emojiLog.length = 0;
    updateHUD();
    if(mode === 'daily'){
      const dk = dayKey(new Date());
      rng = rngFromSeed(dk);
      seedTxt.textContent = dk;
      // update daily streak if first play of day
      const last = localStorage.getItem(LS.LAST_DAY);
      if(last !== dk){
        const yesterday = dayKey(new Date(Date.now() - 86400000));
        let streak = parseInt(localStorage.getItem(LS.DAILY_STREAK) || '0',10);
        if(last === yesterday) streak += 1; else streak = 1;
        localStorage.setItem(LS.DAILY_STREAK, String(streak));
        localStorage.setItem(LS.LAST_DAY, dk);
      }
    } else {
      rng = rngFromSeed(String(Date.now()));
      seedTxt.textContent = '‚Äî';
    }
    nextRound();
    tick = setInterval(()=>{
      timeLeft -= 1; updateHUD();
      if(timeLeft <= 0){ clearInterval(tick); endGame(); }
    }, 1000);
  }

  function endGame(){
    if(tick){ clearInterval(tick); tick = null; }
    goSummary.textContent = `Score ${score} ‚Ä¢ Strikes ${strikes} ‚Ä¢ ${mode==='daily' ? 'Day '+seedTxt.textContent : 'Endless'}`;
    emojiLogEl.textContent = emojiLog.join('');
    overlay.classList.add('show');
  }

  function shareNow(){
    const dk = mode==='daily' ? seedTxt.textContent : 'Endless';
    const msg = `TapSum ‚Äî ${dk}\nScore: ${score} in 60s ‚Ä¢ Strikes: ${strikes}\n${emojiLog.join('')}\n`;
    if(navigator.share){ navigator.share({text: msg}).catch(()=> copyMsg(msg)); }
    else copyMsg(msg);
  }
  function copyMsg(msg){
    navigator.clipboard?.writeText(msg).then(()=> showToast('Copied to clipboard')).catch(()=> showToast('Copy not available'));
  }

  // expose for debugging
  window._TapSum = { startGame, setMode };

  // kick off
  seedTxt.textContent = dayKey(new Date());
  startGame();
  </script>
</body>
</html>
