<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Longshot</title>
<style>
  :root { --bg:#0b1220; --panel:#121a2c; --ink:#e8eefc; --muted:#93a3c9; --bd:rgba(255,255,255,.08);
          --accent:#7dd3fc; --ok:#34d399; --err:#fb7185; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:560px;margin:0 auto;padding:16px 16px 28px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h1{margin:0;font-size:20px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--bd);
        border-radius:999px;background:#0e1729}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 12px}
  .cell{height:76px;border-radius:14px;border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;
        font-weight:800;font-size:26px;cursor:pointer;user-select:none;transition:transform .05s ease, background .1s}
  .cell:active{transform:scale(.98)}
  .cell.sel{outline:2px solid var(--accent);background:rgba(125,211,252,.12)}
  .row{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:8px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:#e8eefc;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .status{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-top:6px}
  .shots{letter-spacing:2px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .toast{height:20px;text-align:center;font-size:14px;margin-top:8px}
  .muted{color:var(--muted)}
  @media(min-width:560px){ .cell{height:96px;font-size:28px} }
  /* tiny shake when you try an invalid non-adjacent step */
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }
  .shake{animation:shake .15s}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Longshot</h1>
    <span class="pill">Streak <strong id="streak">0</strong></span>
  </header>

  <div class="panel">
    <div id="grid" class="grid" role="group" aria-label="letter grid"></div>

    <div class="row">
      <button id="submit" class="btn" disabled>Submit</button>
    </div>

    <div class="status">
      <div id="today" class="muted"></div>
      <div><span class="muted">Shots:</span> <span id="shots" class="shots">● ○ ○</span></div>
    </div>

    <div id="toast" class="toast muted" aria-live="polite"></div>
  </div>

  <p class="muted" style="margin-top:10px">Tap letters to trace a word (8-direction adjacency, no tile reuse). Submit up to 3 times per UTC day.</p>
</div>

<script>
(function(){
  // ===== Daily seed (UTC) =====
  function dayIndexUTC(d=new Date()){
    return Math.floor(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) / 86400000);
  }
  const DAY = dayIndexUTC();

  // ===== Seeded RNG (mulberry32) =====
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
  const rng = mulberry32((DAY ^ 0x9E3779B9) >>> 0);

  // ===== Weighted letter bag (English-ish) =====
  const bag = [
    ...'E'.repeat(12), ...'A'.repeat(9), ...'R'.repeat(8), ...'I'.repeat(8),
    ...'O'.repeat(8),  ...'T'.repeat(7), ...'L'.repeat(6), ...'N'.repeat(6),
    ...'S'.repeat(6),  ...'D'.repeat(4), ...'U'.repeat(4), ...'G'.repeat(3),
    ...'H'.repeat(3),  ...'C'.repeat(3), ...'M'.repeat(3), ...'F'.repeat(2),
    ...'Y'.repeat(2),  ...'W'.repeat(2), ...'K'.repeat(1), ...'V'.repeat(1),
    ...'B'.repeat(1),  ...'P'.repeat(1), ...'J'.repeat(1), ...'X'.repeat(1),
    ...'Q'.repeat(1),  ...'Z'.repeat(1)
  ];
  const pick = ()=> bag[Math.floor(rng()*bag.length)];

  // ===== Local persistence =====
  const NS = "longshot_v1";
  const KEY = (k)=>`${NS}_${k}`;
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(KEY("state"))||"{}"); }catch{ return {}; }
  }
  function saveState(s){ localStorage.setItem(KEY("state"), JSON.stringify(s)); }

  // ===== DOM refs =====
  const gridEl   = document.getElementById('grid');
  const submitEl = document.getElementById('submit');
  const shotsEl  = document.getElementById('shots');
  const toastEl  = document.getElementById('toast');
  const todayEl  = document.getElementById('today');
  const streakEl = document.getElementById('streak');

  // ===== Dictionary (optional) =====
  let dictReady = false;
  let dict = null; // Set<string>
  (async function(){
    try{
      const res = await fetch("/data/words_common.json", { cache:"force-cache" });
      if (res.ok){
        const arr = await res.json();
        dict = new Set(arr);
        dictReady = true;
      }
    }catch(_){ /* optional */ }
  })();

  // ===== Game/session state =====
  let grid = [];               // array of 16 letters
  let selected = [];           // indices path
  let attempts = [];           // [{word,len,valid,ts}]
  let completed = false;
  let lastPlayedDay = null;
  let streak = 0;

  function setToast(msg, cls="muted"){ toastEl.textContent = msg; toastEl.className = `toast ${cls}`; }
  function setShots(n){
    const dots = ["●","○","○"];
    if (n>=2) dots[1]="●";
    if (n>=3) dots[2]="●";
    shotsEl.textContent = dots.join(" ");
  }

  // ===== Build / load today's board =====
  function newBoard(){
    grid = Array.from({length:16}, pick);
  }

  function initFromStorage(){
    const s = loadState();
    // New day → reset daily progress but keep streak logic
    if (!s.day || s.day !== DAY){
      // streak will update upon first submit of the day
      newBoard();
      attempts = [];
      completed = false;
      lastPlayedDay = s.lastPlayedDay ?? null;
      streak = s.streak ?? 0;
      persist();
    } else {
      grid = s.grid || Array.from({length:16}, pick);
      attempts = s.attempts || [];
      completed = !!s.completed;
      streak = s.streak || 0;
      lastPlayedDay = s.lastPlayedDay ?? null;
    }
    streakEl.textContent = streak;
    todayEl.textContent = new Date().toUTCString().slice(0,16) + " UTC";
    setShots(attempts.length);
    if (completed) {
      setToast("All shots used. Come back tomorrow.", "ok");
      submitEl.disabled = true;
    }
  }

  function persist(){
    saveState({ day:DAY, grid, attempts, completed, streak, lastPlayedDay });
  }

  // ===== Render grid =====
  function renderGrid(){
    gridEl.innerHTML = "";
    grid.forEach((ch, idx)=>{
      const d = document.createElement('div');
      d.className = 'cell';
      d.textContent = ch;
      d.dataset.idx = idx;
      gridEl.appendChild(d);
    });
  }

  // ===== Adjacency =====
  function isNeighbor(a,b){
    const ax=a%4, ay=(a/4)|0, bx=b%4, by=(b/4)|0;
    return Math.max(Math.abs(ax-bx), Math.abs(ay-by)) === 1; // 8-way
  }

  function updateSelectionUI(){
    // clear all
    gridEl.querySelectorAll('.cell').forEach(c=>c.classList.remove('sel'));
    selected.forEach(i=>{
      const c = gridEl.querySelector(`.cell[data-idx="${i}"]`);
      if (c) c.classList.add('sel');
    });
    submitEl.disabled = selected.length < 3 || completed;
  }

  // Click handling
  gridEl.addEventListener('click', (e)=>{
    const cell = e.target.closest('.cell'); if (!cell) return;
    if (completed) return;

    const idx = parseInt(cell.dataset.idx,10);
    const last = selected[selected.length-1];

    // Toggling last = undo
    if (selected.length && idx === last){
      selected.pop();
      updateSelectionUI();
      return;
    }

    // Prevent reusing earlier tiles
    if (selected.includes(idx)){ // ignore (not last)
      shake(cell); return;
    }

    // First pick ok; subsequent must be neighbor
    if (selected.length === 0 || isNeighbor(last, idx)){
      selected.push(idx);
      updateSelectionUI();
    } else {
      shake(cell);
    }
  });

  function shake(el){
    el.classList.add('shake');
    setTimeout(()=>el.classList.remove('shake'), 150);
  }

  // ===== Submit =====
  submitEl.addEventListener('click', ()=>{
    if (completed || selected.length < 3) return;

    const word = selected.map(i=>grid[i]).join('').toLowerCase();
    const valid = dictReady ? dict.has(word) : true; // if no dictionary, accept any 3+ path
    const entry = { word, len: word.length, valid, ts: Date.now() };
    attempts.push(entry);

    // streak bookkeeping on first submit of the day
    if (attempts.length === 1){
      if (lastPlayedDay == null || lastPlayedDay < DAY-1) streak = 1;
      else if (lastPlayedDay === DAY-1) streak = (streak||0) + 1;
      // if lastPlayedDay === DAY, do nothing (retries within same day)
      lastPlayedDay = DAY;
      streakEl.textContent = streak;
    }

    // feedback
    if (!valid) setToast(`✗ “${entry.word.toUpperCase()}” not in list`, "err");
    else        setToast(`✓ “${entry.word.toUpperCase()}” submitted (len ${entry.len})`, "ok");

    // clear current path
    selected = [];
    updateSelectionUI();

    // mark completion
    if (attempts.length >= 3){
      completed = true;
      submitEl.disabled = true;
      setToast("All shots used. Come back tomorrow.", "ok");
    }

    setShots(attempts.length);
    persist();
  });

  // ===== Boot =====
  initFromStorage();
  renderGrid();
  updateSelectionUI();
})();
</script>
</body>
</html>