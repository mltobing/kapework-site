<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Longshot - Daily Word Puzzle</title>
<meta name="description" content="Find the longest word in today's 4√ó4 letter grid. New puzzle daily!">
<style>
  :root { --bg:#0b1220; --panel:#121a2c; --ink:#e8eefc; --muted:#93a3c9; --bd:rgba(255,255,255,.08);
          --accent:#7dd3fc; --ok:#34d399; --err:#fb7185; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:560px;margin:0 auto;padding:16px 16px 28px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h1{margin:0;font-size:20px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#0e1729}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 10px}
  .cell{height:76px;border-radius:14px;border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;
        font-weight:800;font-size:26px;cursor:pointer;user-select:none;transition:transform .05s ease, background .1s, box-shadow .2s}
  .cell:active{transform:scale(.98)}
  .cell.sel{outline:2px solid var(--accent);background:rgba(125,211,252,.12)}
  .cell.hot{box-shadow:0 0 0 2px rgba(125,211,252,.35), 0 0 22px rgba(125,211,252,.25) inset}
  .row{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:6px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:#e8eefc;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .status{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-top:6px;gap:8px;flex-wrap:wrap}
  .shots{letter-spacing:2px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .toast{min-height:20px;text-align:center;font-size:14px;margin-top:8px}
  .muted{color:var(--muted)}
  .closer{display:flex;justify-content:center;gap:8px;align-items:center;margin-top:6px}
  .bar{height:10px;border-radius:999px;border:1px solid var(--bd);background:rgba(255,255,255,.04);width:220px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#34d399,#7dd3fc);width:0%}
  .archive{margin-top:10px;padding:10px;border-top:1px solid var(--bd)}
  .archive-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
  .day-btn{padding:8px;border:1px solid var(--bd);border-radius:8px;background:#0e1729;font-size:12px;cursor:pointer}
  .day-btn.played{background:rgba(125,211,252,.12)}
  .day-btn.current{outline:2px solid var(--accent)}
  @media(min-width:560px){ .cell{height:96px;font-size:28px} }
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }
  .shake{animation:shake .15s}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Longshot <span class="muted" id="puzzleNum"></span></h1>
    <span class="pill">Streak <strong id="streak">0</strong></span>
  </header>

  <div class="panel">
    <div id="grid" class="grid" role="group" aria-label="letter grid"></div>

    <div class="row">
      <button id="submit" class="btn" disabled>Submit</button>
      <button id="share" class="btn" style="display:none">Share</button>
      <button id="archive-toggle" class="btn">Archive</button>
    </div>

    <div class="status">
      <div id="today" class="muted"></div>
      <div><span class="muted">Shots:</span> <span id="shots" class="shots">‚óè ‚óã ‚óã</span></div>
      <div id="bestline" class="muted"></div>
    </div>

    <div class="closer" id="closer" style="display:none">
      <div class="bar"><div id="fill" class="fill"></div></div>
      <div id="pct" class="muted">0%</div>
      <div id="medal" style="min-width:1.5rem;text-align:center"></div>
    </div>

    <div id="toast" class="toast muted" aria-live="polite"></div>

    <div id="archive" class="archive" style="display:none">
      <div class="muted" style="font-size:13px">Play past puzzles (doesn't affect streak)</div>
      <div id="archive-grid" class="archive-grid"></div>
    </div>
  </div>

  <p class="muted" style="margin-top:10px">Tap letters (8‚Äëway adjacency, no reuse). 3 shots per UTC day. Tap last letter again to undo.</p>
</div>

<!-- Supabase for play tracking -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(function(){
  // ===== Configuration =====
  const SUPABASE_URL  = "https://fimsbfcvavpehryvvcho.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpbXNiZmN2YXZwZWhyeXZ2Y2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTEwMDMsImV4cCI6MjA3MDk2NzAwM30.6uAm_bDPN9aetYaKWA7zCvS8XDEVhmKKxA7RA7YK4JQ";
  const SLUG = "longshot";
  let sb = null;

  // ===== Daily seed (UTC) =====
  function dayIndexUTC(d=new Date()){
    return Math.floor(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) / 86400000);
  }
  const TODAY = dayIndexUTC();
  let CURRENT_DAY = TODAY; // Can change when playing archive
  document.getElementById('puzzleNum').textContent = `#${CURRENT_DAY}`;

  // ===== Seeded RNG (mulberry32) =====
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
  let rngFunc = mulberry32((CURRENT_DAY ^ 0x9E3779B9) >>> 0);

  // ===== Device ID for tracking =====
  const DID_KEY = "kapework_did_v1";
  let deviceId = localStorage.getItem(DID_KEY);
  if (!deviceId) { 
    deviceId = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); 
    localStorage.setItem(DID_KEY, deviceId); 
  }

  // ===== Weighted letter bag =====
  const bag = [
    ...'E'.repeat(12), ...'A'.repeat(9), ...'R'.repeat(8), ...'I'.repeat(8),
    ...'O'.repeat(8),  ...'T'.repeat(7), ...'L'.repeat(6), ...'N'.repeat(6),
    ...'S'.repeat(6),  ...'D'.repeat(4), ...'U'.repeat(4), ...'G'.repeat(3),
    ...'H'.repeat(3),  ...'C'.repeat(3), ...'M'.repeat(3), ...'F'.repeat(2),
    ...'Y'.repeat(2),  ...'W'.repeat(2), ...'K'.repeat(1), ...'V'.repeat(1),
    ...'B'.repeat(1),  ...'P'.repeat(1), ...'J'.repeat(1), ...'X'.repeat(1),
    ...'Q'.repeat(1),  ...'Z'.repeat(1)
  ];
  const pick = ()=> bag[Math.floor(rngFunc()*bag.length)];

  // ===== Local persistence =====
  const NS = "longshot_v4"; // Bumped version to clear corrupted v3 states
  const KEY = (k)=>`${NS}_${k}`;
  const todayEl  = document.getElementById('today');
  todayEl.textContent = new Date().toUTCString().slice(0,16) + " UTC";
  
  function loadState(day=TODAY){ 
    try{ 
      const key = `${NS}_state_${day}`;
      return JSON.parse(localStorage.getItem(key)||"{}"); 
    }catch{return{}} 
  }
  function saveState(s, day=TODAY){ 
    const key = `${NS}_state_${day}`;
    localStorage.setItem(key, JSON.stringify(s)); 
  }

  // ===== DOM refs =====
  const gridEl   = document.getElementById('grid');
  const submitEl = document.getElementById('submit');
  const shareEl  = document.getElementById('share');
  const shotsEl  = document.getElementById('shots');
  const toastEl  = document.getElementById('toast');
  const closerEl = document.getElementById('closer');
  const fillEl   = document.getElementById('fill');
  const pctEl    = document.getElementById('pct');
  const medalEl  = document.getElementById('medal');
  const bestline = document.getElementById('bestline');
  const streakEl = document.getElementById('streak');
  const archiveToggleEl = document.getElementById('archive-toggle');
  const archiveEl = document.getElementById('archive');
  const archiveGridEl = document.getElementById('archive-grid');

  function setToast(msg, cls="muted"){ toastEl.textContent = msg; toastEl.className = `toast ${cls}`; }
  function setShots(n){
    const dots = ["‚óè","‚óã","‚óã"]; if (n>=2) dots[1]="‚óè"; if (n>=3) dots[2]="‚óè";
    shotsEl.textContent = dots.join(" ");
  }

  // ===== Dictionary & trie =====
  let dictSet = null, trie = null, dictLabel = "mini";

  // ===== Embedded word list (~3600 common words) =====
  const EMBEDDED_WORDS = ["able","about","above","abuse","ache","acids","acre","acres","adapt","add","added","admit","adopt","adult","after","again","age","aged","agent","aging","ago","agree","ahead","aid","aide","aim","aimed","air","alarm","album","alert","alien","align","alike","alive","all","allow","alloy","ally","aloft","alone","along","aloud","alpha","also","altar","alter","amino","among","ample","and","angel","anger","angle","angry","ant","anti","any","apart","apply","arch","are","area","arena","arise","arm","armor","army","arose","array","arrow","art","aside","asked","asset","ate","atlas","atom","aunt","avoid","awake","award","aware","away","awful","baby","back","backs","bacon","bad","badge","badly","bag","bail","bait","baked","bald","ball","balls","ban","band","bands","bank","banks","bar","bare","bark","barn","base","based","bases","basic","basin","basis","bat","batch","bath","baths","bay","beach","bead","beads","beak","beam","beams","bean","beans","bear","beard","bears","beast","beat","beats","bed","beef","been","beer","began","begin","begun","being","bell","bells","belly","below","belt","belts","bench","bend","bent","berry","best","bet","bias","bid","big","bike","bill","bind","bird","birds","birth","bit","bite","black","blade","blame","blank","blast","blaze","bleed","blend","bless","blind","bliss","blitz","block","blond","blood","bloom","blow","blown","blue","blues","blunt","blur","board","boat","boats","body","bogus","boil","bold","bolt","bolts","bomb","bombs","bond","bonds","bone","bones","bonus","book","books","boom","boost","boot","booth","boots","border","bored","born","borrow","boss","botch","both","bound","bow","bowl","bowls","box","boxes","boy","boys","brag","brain","brake","brand","brass","brave","bread","break","breed","brick","bride","brief","brim","bring","brink","brisk","broad","broke","brook","broom","broth","brown","brush","brute","bud","buddy","bug","build","built","bulbs","bulk","bull","bulls","bump","bunch","bunny","burn","burns","burst","bury","bus","buses","bush","busy","but","buy","cab","cabin","cable","cache","cafe","cage","cake","calf","calls","calm","calms","cam","came","camel","camp","camps","can","canal","candy","cane","canon","cap","cape","car","card","cards","care","cared","cares","cargo","carry","cars","cart","carve","case","cases","cash","cast","cat","catch","cause","cave","caves","cease","cell","cells","chain","chair","chalk","champ","chant","chaos","charm","chart","chase","chat","cheap","cheat","check","cheek","cheer","chef","chess","chest","chew","chick","chief","child","chill","chimp","chin","china","chip","chips","choir","chop","chord","chore","chose","chunk","churn","cider","cigar","cited","cites","cities","city","claim","clam","clamp","clan","clap","clash","class","claw","claws","clay","clean","clear","clerk","click","cliff","climb","cling","clip","clips","cloak","clock","clone","close","cloth","cloud","clown","club","clubs","clue","clues","clung","coach","coal","coast","coat","coats","cocoa","code","codes","coin","coins","cold","colon","color","come","comet","comic","comma","conch","condo","cone","cones","cool","cop","cope","copy","coral","cord","cords","core","cores","cork","corn","corny","cost","couch","cough","could","count","coupe","court","cover","cow","cozy","crab","crack","craft","crane","crash","crate","crave","crawl","craze","crazy","cream","creek","creep","crest","crew","crib","crisp","crop","crops","cross","crow","crowd","crown","crude","cruel","crush","crust","cry","cub","cube","cubic","cup","cure","curl","curly","curse","curve","cut","cute","cycle","dad","daddy","daily","dairy","dam","damp","dance","dare","dared","dares","dark","dash","data","date","dawn","day","days","dead","deal","dealt","dear","death","debit","debt","debts","decay","deck","decks","decor","decoy","deed","deem","deep","deer","delay","delta","den","dense","deny","depot","depth","desk","desks","dew","dial","did","die","died","diet","dig","digit","dim","dimly","dine","diner","dip","dire","dirt","dirty","disco","dish","disk","ditch","dive","diver","dizzy","dock","docks","dodge","does","dog","doing","dolls","dome","done","donor","donut","doom","door","dose","doses","doubt","dough","dove","down","downs","doze","dozen","draft","drag","drain","drama","drank","drape","draw","drawl","drawn","draws","dread","dream","dress","drew","dried","drier","drift","drill","drink","drip","drive","droit","drone","droop","drop","drops","drown","drug","drugs","drum","drums","drunk","dry","dryer","dual","dub","duck","ducks","ducts","dude","due","duel","dug","dump","dune","dunes","dunk","dunks","dural","dusk","dust","dusty","duty","dwell","dye","dyer","dying","each","eager","eagle","ear","early","earn","ears","earth","ease","eased","east","easy","eat","eaten","eater","ebony","echo","edge","edges","edit","eerie","egg","eight","elbow","elder","elect","elf","elite","elm","else","embed","ember","emit","emoji","empty","end","ended","enemy","enjoy","enter","entry","envy","epic","equal","equip","era","erase","erode","error","essay","ethic","eve","even","event","ever","every","evil","exact","exam","exams","excel","exert","exile","exist","exit","exits","extra","eye","eyes","fable","face","faced","faces","fact","facts","fad","fade","faded","fail","fails","faint","fair","fairy","faith","fake","fall","falls","false","fame","famed","fan","fancy","fang","fangs","far","farce","fare","farm","farms","fast","fat","fatal","fate","fatty","fault","fauna","favor","fawn","fax","fear","feast","feat","fed","fee","feed","feel","feels","fees","feet","fell","felt","fence","fern","ferry","fetal","fetch","feud","fever","few","fiber","field","fiery","fifth","fifty","fig","fight","file","filed","files","fill","fills","film","films","filth","fin","final","find","finds","fine","finer","fire","fires","firm","firms","first","fish","fist","fit","fits","five","fix","fixed","fixes","flag","flags","flair","flame","flank","flap","flare","flash","flask","flat","flats","flaw","flaws","fled","flesh","flew","flies","fling","flint","flip","flit","float","flock","flog","flood","floor","flop","floss","flour","flow","flown","flows","fluid","flung","flush","flute","foam","foams","focal","focus","foe","fog","fold","folk","folks","fond","font","food","fool","foot","for","force","fork","form","forms","fort","forth","forty","forum","fossil","foul","found","four","fowl","fox","frame","frank","fraud","freak","free","freed","fresh","friar","fried","fries","frill","frog","frogs","from","front","frost","frown","froze","fruit","fudge","fuel","fuels","full","fully","fume","fumes","fun","fund","funds","funny","fur","fuss","fuzz","fuzzy","gag","gaily","gain","gains","gait","gale","game","games","gang","gangs","gap","gas","gases","gates","gauge","gauze","gavel","gaze","gazes","gear","gears","gel","gem","gene","genes","genre","genus","germs","get","gets","ghost","giant","gift","gifts","gig","gilt","girl","girls","give","given","giver","gives","glad","gland","glare","glass","glaze","gleam","glen","glide","globe","gloom","glory","gloss","glove","glow","glows","glue","glued","glues","gnome","goal","goals","goat","goats","god","goes","going","gold","golds","golf","gone","gonna","good","goods","goose","got","gown","grab","grace","grade","grain","grand","grant","grape","graph","grasp","grass","grave","gravy","gray","grays","greed","greek","green","greet","grew","grey","grid","grief","grill","grim","grin","grind","grip","grips","groan","groin","groom","gross","group","grove","grow","grown","grows","guard","guess","guest","guide","guild","guilt","guise","gulf","gulls","gum","gummy","gun","gust","gusto","gusts","gusty","gut","guy","guys","gym","habit","hack","had","haiku","hail","hair","half","hall","halls","halt","halts","ham","hand","hands","handy","hang","hangs","happy","hard","hardy","harm","harp","harsh","has","haste","hasty","hat","hatch","hate","hated","hater","hates","haul","haunt","have","haven","havoc","hawk","hawks","hay","haze","hazel","head","heads","heady","heal","heals","heap","hear","heard","heart","heat","heath","heave","heavy","hedge","heel","heels","hefty","heist","held","hell","hello","help","helps","hem","hen","hence","her","herbs","herd","herds","here","hero","heron","heros","hid","hide","hides","high","highs","hike","hiked","hiker","hikes","hill","hills","hilts","him","hinds","hinge","hint","hints","hip","hippo","hire","hired","his","hit","hitch","hive","hives","hoary","hobby","hog","hoist","hold","holds","hole","holes","holly","home","homes","honey","honk","honor","hood","hoods","hook","hooks","hoops","hop","hope","hoped","hopes","horn","horns","horse","hose","hoses","host","hosts","hot","hotel","hound","hour","hours","house","hover","how","hub","hue","huffs","hug","huge","hum","human","humid","humor","hump","humps","hung","hunt","hunts","hurry","hurt","hurts","husk","husks","husky","hut","hyena","hymn","ice","icons","ideal","ideas","idiom","idiot","idols","ill","image","imply","inane","inbox","inch","index","indie","infos","ink","inn","inner","input","insane","inter","into","intro","ion","irate","irked","iron","irons","irony","issue","item","items","its","ivory","ivy","jab","jack","jacks","jail","jails","jam","japan","jar","jaw","jeans","jeep","jelly","jerk","jerks","jest","jet","jewel","jiffy","jig","job","jobs","jock","jog","join","joins","joint","joke","joker","jokes","jolly","jolt","joust","joy","joys","judge","jug","juice","juicy","jumbo","jump","jumps","jumpy","june","junk","junks","junta","juror","jury","just","kayak","keels","keen","keep","keeps","kept","ketch","key","kick","kid","kids","kill","kin","kind","king","kiss","kit","kite","kites","kitty","knack","knead","knee","knees","knelt","knew","knife","knit","knits","knob","knobs","knock","knot","knots","know","known","knows","lab","label","labor","lace","laced","laces","lack","lacks","lad","laden","ladle","lady","lag","lager","laid","lake","lakes","lambs","lamp","lamps","lance","land","lands","lane","lanes","lap","lapel","lapse","large","larva","laser","last","lasts","latch","late","later","latex","laugh","law","lawn","lawns","laws","lay","layer","lazy","leach","lead","leads","leaf","leak","leaky","lean","leap","leaps","learn","lease","leash","least","leave","led","ledge","left","leg","legal","lemon","lemur","lend","lens","leper","less","let","level","lever","liar","lice","lick","licks","lid","liens","life","lift","light","like","liked","likes","limb","limbo","limbs","lime","limit","limp","limps","line","lined","linen","liner","lines","link","links","lion","lions","lip","lipid","lips","list","lists","lit","liter","litre","live","lived","liven","liver","lives","livid","llama","load","loads","loaf","loan","loans","lobby","local","lock","locus","lodge","loft","lofts","log","logic","logo","logos","lone","loner","long","look","looks","looms","loop","loops","loose","lord","lords","lose","loser","loses","loss","lost","lot","lotus","loud","lousy","love","loved","lover","loves","low","lower","loyal","lucid","luck","lucky","lulls","lump","lumps","lumpy","lunar","lunch","lung","lungs","lurch","lure","lured","lures","lurk","lurks","lush","lusty","lying","lymph","lyric","macro","mad","madam","made","mafia","magic","magma","magna","mail","mails","main","mainly","major","make","maker","makes","male","males","mall","malls","mamma","man","mane","mango","mania","manor","many","map","maple","maps","march","mark","marks","marry","marsh","mask","masks","mason","mass","mast","mat","match","mate","mates","math","maths","mauve","maxim","may","mayor","maze","mazes","meal","meals","mean","means","meant","meat","meats","medal","media","meek","meet","melee","melon","melt","memo","men","mend","menu","menus","mercy","mere","merge","merit","merry","mesh","mess","messy","met","metal","meter","metro","mice","micro","midst","might","mild","mile","miles","milk","milky","mill","mills","mince","mind","minds","mine","miner","mines","minor","mint","mints","minus","miss","mist","misty","mix","mixed","mixes","moan","moans","moat","mob","mock","mode","model","modem","modes","moist","molar","mold","molds","moldy","mole","mom","money","monk","monks","month","mood","moods","moody","moon","moons","moose","mop","moral","more","mores","morph","morse","moss","mossy","most","motel","moth","moths","motor","motto","mould","mount","mourn","mouse","mouth","move","moved","mover","moves","movie","much","mucus","mud","muddy","mug","mulch","mule","mummy","munch","murky","muse","mused","muses","music","must","musty","mute","myth","nail","nails","naive","naked","name","named","names","nanny","nap","nape","napes","nasal","nasty","natal","naval","navel","navy","near","nears","neat","neck","need","needs","neon","nerve","nest","nests","net","nets","never","new","newer","newly","news","next","nexus","nice","nicer","niche","nick","nicks","niece","night","nine","ninja","ninth","noble","nod","node","nodes","nods","noise","nomad","none","nooks","noon","nor","norm","norms","north","nose","nosey","not","notch","note","noted","notes","noun","nouns","novel","now","nun","nurse","nut","nutty","oak","oaken","oaks","oar","oasis","oat","obey","occur","ocean","odd","oddly","odds","odors","off","offer","often","oil","oiled","oils","okay","old","oldie","olive","omega","once","one","only","onset","onto","open","opera","opt","opted","optic","oral","orb","orbit","order","ore","ores","organ","other","otter","ought","ounce","our","ours","out","outer","ova","oval","ovals","ovary","oven","ovens","over","overt","owe","owed","owes","owl","own","owner","owns","oxide","ozone","pace","paced","pacer","paces","pack","packs","pact","pad","paddy","pagan","page","pages","paid","pail","pain","pains","paint","pair","pairs","pal","pale","palm","palms","pan","pane","pangs","panic","pansy","pant","pants","paper","par","park","parks","part","parts","party","pass","past","pasta","paste","pat","patch","path","patio","pause","pave","paved","paver","paves","paw","pawn","pay","pays","pea","peace","peach","peak","peaks","peals","pear","pearl","pears","peas","peat","peck","pecks","pedal","peek","peel","peer","peers","peg","pelt","pen","penal","penny","pens","per","perch","peril","perk","perks","perky","pest","pests","pet","petal","petty","phase","phone","phony","photo","piano","pick","picks","picky","pie","piece","pier","piers","pig","piggy","pike","pile","piles","pills","pilot","pin","pinch","pine","pines","piney","pink","pinks","pint","pinto","pints","pious","pipe","pipes","pit","pitch","pithy","pivot","pixel","pizza","place","plaid","plain","plan","plane","plans","plant","plate","play","plays","plaza","plea","plead","pleas","pleat","plod","plods","plot","plots","plow","plows","pluck","plug","plugs","plum","plumb","plump","plums","plunk","plus","plush","ply","pod","poem","poems","poet","poets","point","poise","poke","poked","poker","pokes","polar","pole","poles","polio","polka","poll","polls","pond","ponds","pony","pool","pools","poor","pop","pope","pops","porch","pores","pork","porky","port","ports","pose","posed","poser","poses","post","posts","pot","pouch","pound","pour","pours","power","prank","prawn","pray","prays","preen","prep","press","prey","preys","price","prick","pride","prime","print","prior","prism","privy","prize","pro","probe","prod","prods","proms","prone","prong","proof","prop","props","prose","proud","prove","prowl","proxy","prude","prune","psalm","pub","pudgy","puffs","puffy","pull","pulls","pulp","pulse","pump","pumps","pun","punch","punk","punks","pup","pupil","puppy","pure","purge","purse","push","pushy","put","putty","pygmy","quack","quads","quake","qualm","quart","quasi","queen","queer","query","quest","queue","quick","quiet","quill","quilt","quips","quirk","quit","quota","quote","rabbi","rabid","race","racer","races","racks","radar","radii","radio","radon","raft","rafts","rag","rage","raged","rages","raid","raids","rail","rails","rain","rainy","raise","rake","raked","rakes","rally","ram","ramp","ramps","ran","ranch","rang","range","rank","ranks","rap","rapid","rare","rares","rash","rat","rate","rated","rates","ratio","rats","rave","raw","ray","rays","reach","react","read","reads","ready","real","realm","ream","reams","reap","rear","rears","rebel","recap","recur","red","reeds","reedy","reef","reefs","reek","reeks","reel","reels","refer","reign","reins","relax","relay","relic","rely","remit","remix","renal","renew","rent","repay","reply","rerun","reset","resin","rest","rests","retro","retry","reuse","revue","rhino","rhyme","rice","rich","rid","ride","ridge","rifle","rift","rig","right","rigid","rigor","rim","rinds","ring","rings","riot","riots","rip","ripe","ripen","rise","risen","riser","rises","risk","risks","risky","rites","ritzy","rival","river","road","roads","roam","roar","roars","roast","rob","robe","robed","robes","robot","rock","rocks","rocky","rod","rode","rodeo","rogue","role","roles","roll","rolls","roman","romps","roof","roofs","room","rooms","root","roots","rope","ropes","rose","roses","rosy","rot","rouge","rough","round","rout","route","row","royal","rub","rude","ruder","rug","ruin","ruins","rule","ruled","ruler","rules","rumor","run","rung","rungs","runny","runs","rural","rush","rust","rusts","rusty","rut","rye","saber","sable","sad","sadly","safe","safer","safes","sag","sage","said","sail","saint","sake","salad","sale","salon","salsa","salt","salts","salve","salvo","same","sand","sands","sandy","sane","saner","sang","sank","santa","sap","sassy","sat","satin","sauce","saucy","sauna","saute","save","saved","saver","saves","savor","savvy","saw","sawed","say","sayer","says","scale","scalp","scaly","scamp","scams","scan","scant","scar","scare","scarf","scars","scary","scene","scent","scold","scone","scoop","scoot","scope","score","scorn","scout","scowl","scrap","screw","scuba","sea","seal","seals","seam","seams","seas","seat","seats","sect","see","seed","seeds","seedy","seek","seeks","seem","seems","seen","seeps","seize","self","sell","semis","send","sends","sense","sent","sepia","serum","serve","set","setup","seven","sever","sew","sewed","sewer","shade","shady","shaft","shake","shaky","shall","shame","shape","shard","share","shark","sharp","shave","shawl","she","shed","sheds","sheen","sheep","sheer","sheet","shelf","shell","shift","shims","shine","shins","shiny","ship","ships","shire","shirk","shirt","shock","shook","shoot","shop","shops","shore","short","shot","shout","shove","show","shown","shows","showy","shred","shrub","shrug","shuck","shuns","shunt","shut","shuts","shy","sick","side","sides","siege","sieve","sigh","sight","sigma","sign","signs","silk","silks","silky","sills","silly","sin","since","sinew","singe","sink","sinks","sip","sir","siren","sissy","sit","site","sites","six","sixth","sixty","size","sized","sizes","skate","skeet","ski","skids","skied","skies","skill","skimp","skims","skin","skins","skip","skips","skirt","skull","sky","slab","slabs","slack","slain","slam","slams","slang","slant","slap","slash","slat","slate","slats","slave","slays","sled","sleds","sleek","sleep","sleet","slept","slew","slice","slick","slid","slide","slim","slime","slimy","sling","slink","slip","slips","slit","slits","slobs","slope","slops","slosh","sloth","slots","slow","slows","slug","slum","slump","slung","slunk","slurp","slurs","slush","sly","slyly","smack","small","smart","smash","smear","smell","smelt","smile","smirk","smoke","smoky","snack","snafu","snags","snail","snake","snap","snaps","snare","snarl","sneak","sneer","snide","sniff","snipe","snob","snore","snort","snout","snow","snowy","snuck","snuff","snugs","soak","soaks","soap","soaps","soapy","soar","soars","sob","sober","sock","socks","sod","soda","sofa","sofas","soft","soggy","soil","soils","solar","sold","sole","soled","soles","solid","solos","solve","some","son","sonar","song","songs","sonic","sons","soon","soothe","sop","sore","sorry","sort","sorts","soul","souls","sound","soup","soups","sour","south","sow","soy","spa","space","spade","span","spank","spar","spare","spark","spars","spasm","spawn","speak","spear","specs","sped","speed","spell","spend","spent","sperm","spice","spicy","spied","spies","spill","spilt","spin","spine","spins","spit","spite","splat","split","spoil","spoke","spoof","spook","spool","spoon","spore","sport","spot","spots","spout","spray","spree","sprig","sprung","spun","spunk","spur","spurs","spy","squad","squat","squaw","squid","stab","stack","staff","stag","stage","stain","stair","stake","stalk","stall","stamp","stand","stank","star","stare","stark","stars","start","stash","state","stave","stay","stays","stead","steak","steal","steam","steel","steep","steer","stem","stems","step","steps","stern","stew","stews","stick","stiff","still","sting","stink","stint","stir","stirs","stock","stoic","stoke","stole","stomp","stone","stood","stool","stoop","stop","stops","store","storm","story","stout","stove","stow","strap","straw","stray","strep","strip","strode","stroke","stroll","strong","strove","struck","strung","strut","stub","stuck","stud","studs","study","stuff","stump","stun","stung","stunk","stunt","sty","style","suave","sub","such","suck","sucks","suede","sugar","suit","suite","suits","sulky","sully","sum","sumac","sums","sun","sung","sunk","sunny","super","sure","surf","surge","surly","swabs","swamp","swans","swap","swaps","swarm","swath","sway","sways","swear","sweat","sweep","sweet","swell","swept","swift","swim","swims","swine","swing","swipe","swirl","swish","swiss","swoop","sword","swore","sworn","swum","swung","syrup","tab","table","tabs","tacit","tack","tacks","tacky","tact","tad","tag","tail","tails","take","taken","taker","takes","tale","tales","talk","talks","tall","tally","tame","tamed","tamer","tames","tan","tandem","tango","tangy","tank","tanks","tap","tape","taper","tapes","tar","tardy","tarps","tarry","task","tasks","taste","tasty","tatty","taunt","tax","taxa","taxes","tea","teach","teaks","teals","teams","tear","tears","teary","tease","tech","techs","teddy","teem","teen","teens","teeth","tell","tells","tempo","tempt","ten","tend","tends","tens","tense","tent","tenth","tents","tepid","term","terms","terra","test","tests","text","texts","than","thank","that","thaws","the","theft","their","them","theme","then","there","these","they","thick","thief","thigh","thin","thing","think","third","this","thong","thorn","those","three","threw","throb","throw","thuds","thumb","thump","thunk","thus","tick","ticks","tidal","tide","tides","tidy","tie","tied","tier","tiers","ties","tiger","tight","tile","tiles","till","tills","tilt","tilts","time","timer","times","timid","tin","tinge","tints","tiny","tip","tips","tipsy","tire","tired","tires","titan","title","titty","toad","toads","toast","today","toddy","toe","toes","toffs","togas","toil","toked","token","told","toll","tolls","tomb","tombs","ton","tonal","tone","toned","toner","tones","tonic","tons","too","took","tool","tools","tooth","top","topaz","topic","tops","torch","tore","torn","torso","tort","torts","total","totem","touch","tough","tour","tours","tow","towel","tower","town","towns","toxic","toxin","toy","trace","track","tract","trade","trail","train","trait","tramp","trams","trap","traps","trash","tray","trays","tread","treat","tree","trees","trek","treks","trend","tress","trial","tribe","trick","tried","trier","tries","trim","trims","trio","trios","trip","trips","trite","trod","troll","tromp","troop","trot","trots","trout","truce","truck","true","truly","trump","trunk","truss","trust","truth","try","tryst","tub","tube","tubes","tuck","tucks","tudor","tuft","tufts","tug","tulip","tulle","tune","tuned","tuner","tunes","tunic","tuple","turbo","turf","turfs","turn","turns","tusk","tutor","tutus","tuxes","twang","tweak","tweed","tweet","twice","twigs","twin","twine","twins","twirl","twist","two","tying","type","typed","types","typos","udder","ugly","ultra","umber","umbra","uncle","uncut","under","undid","undo","undue","unfed","unfit","unhip","unify","union","unit","unite","units","unity","unlit","unmet","unsay","unto","unwed","unzip","upon","upper","upset","urban","urge","urged","urges","urine","urn","usage","use","used","user","users","uses","usher","using","usual","utter","vague","vain","vale","vales","valet","valid","valor","value","valve","vamps","van","vane","vanes","vapor","vary","vase","vases","vast","vat","vault","vaunt","veers","veil","veils","vein","veins","veldt","venom","vent","vents","venue","verb","verbs","verge","verse","verso","verve","very","vest","vet","veto","via","vibe","vibes","vice","video","vie","view","views","villa","vine","vines","viols","viper","viral","virus","visa","visas","visit","visor","vista","vital","vivid","vixen","vocab","vocal","vodka","vogue","voice","void","voids","volt","volts","vomit","vote","voted","voter","votes","vouch","vowed","vowel","voxel","vulva","wacky","wad","wade","waded","wader","wades","wafer","wafts","wag","wage","waged","wager","wages","wagon","waifs","wail","wails","waist","wait","waits","wake","waked","waken","waker","wakes","walk","walks","wall","walls","waltz","wand","wands","want","wants","war","ward","wards","wares","warm","warn","warns","warp","warps","wars","warts","warty","wary","was","wash","wasp","wasps","waste","watch","water","watts","wave","waved","waver","waves","wavy","wax","waxed","waxen","waxes","waxy","way","ways","weak","wealth","weans","wear","wears","weary","weave","web","webby","wed","wedge","weds","weed","weeds","weedy","week","weeks","weeny","weep","weeps","weigh","weird","weld","well","wells","welsh","wench","went","wept","were","west","wet","whack","whale","wharf","what","wheat","wheel","whelk","whelp","when","where","which","whiff","while","whim","whims","whine","whiny","whip","whips","whirl","whirs","whisk","white","whits","who","whole","whom","whoop","whose","why","wick","wicks","wide","widen","wider","widow","width","wield","wife","wifes","wig","wiggy","wild","wilds","wiles","will","wills","wilt","wilts","wimpy","win","wince","winch","wind","winds","windy","wine","wined","wines","wing","wings","wink","winks","wipe","wiped","wiper","wipes","wire","wired","wires","wise","wised","wiser","wish","wisp","wisps","wispy","wit","witch","with","witty","wives","wok","woke","woken","wolf","wolfs","woman","women","won","wonky","woo","wood","woods","woody","wooer","wool","woozy","word","wordy","wore","work","works","world","worm","worms","wormy","worn","worry","worse","worst","worth","would","wound","woven","wow","wrack","wrap","wraps","wrath","wreak","wreck","wren","wrest","wring","wrist","write","wrong","wrote","wrung","yachts","yak","yam","yanks","yap","yard","yards","yarn","yarns","yawns","yea","year","yearn","years","yeast","yell","yells","yelps","yes","yet","yield","yikes","yoga","yoke","you","young","your","youth","yowls","yucky","yummy","zap","zappy","zeal","zebra","zen","zero","zeros","zests","zesty","zincs","zings","zingy","zip","zippy","zonal","zone","zoned","zones","zoo","zoom"];

  function insertTrie(root, w){
    let node = root;
    for (const ch of w){
      const c = ch.charCodeAt(0) - 97;
      if (c<0 || c>25) return;
      if (!node[c]) node[c] = Object.create(null);
      node = node[c];
    }
    node.$ = 1;
  }
  function buildTrie(words){
    const root = Object.create(null);
    for (const w of words){ if (w.length>=3) insertTrie(root, w); }
    return root;
  }

  async function loadDictionary(){
    // Try CDN-hosted word lists first (works when deployed)
    const CDN_URLS = [
      // Primary: wordlist-english package on unpkg (common words, ~30k words)
      "https://unpkg.com/wordlist-english@1.2.1/english-words-35.json",
      // Fallback: your local file if you have one
      "/data/words_common.json"
    ];
    
    for (const url of CDN_URLS) {
      try {
        const res = await fetch(url, { cache: "force-cache" });
        if (res.ok) {
          const arr = await res.json();
          // Filter to only 3+ letter words (for the game)
          const filtered = arr.filter(w => w.length >= 3 && /^[a-z]+$/.test(w));
          dictSet = new Set(filtered);
          trie = buildTrie(filtered);
          dictLabel = filtered.length > 10000 ? "full" : "common";
          console.log(`Loaded ${filtered.length} words from ${url}`);
          return;
        }
      } catch (e) {
        console.warn(`Failed to load ${url}:`, e);
      }
    }
    
    // Use embedded word list (works everywhere, ~3600 words)
    console.log("Using embedded word list");
    const filtered = EMBEDDED_WORDS.filter(w => w.length >= 3);
    dictSet = new Set(filtered);
    trie = buildTrie(filtered);
    dictLabel = "embedded";
  }

  // ===== Board & solver =====
  let grid = [];
  let selected = [];
  let attempts = [];
  let completed = false;
  let lastPlayedDay = null;
  let streak = 0;

  function neighbors(i){
    const x=i%4, y=(i/4)|0, out=[];
    for (let dy=-1; dy<=1; dy++){
      for (let dx=-1; dx<=1; dx++){
        if (dx===0 && dy===0) continue;
        const nx=x+dx, ny=y+dy;
        if (nx>=0 && nx<4 && ny>=0 && ny<4) out.push(ny*4+nx);
      }
    }
    return out;
  }

  function maxOnBoard(grid, trie){
    let bestLen = 0;
    const examples = new Set();
    let bestPath = [];
    const neigh = Array.from({length:16}, (_,i)=>neighbors(i));

    function dfs(idx, node, visitedMask, wordArr, path){
      const ch = grid[idx].toLowerCase();
      const code = ch.charCodeAt(0)-97;
      const next = node[code];
      if (!next) return;

      const newMask = visitedMask | (1<<idx);
      const newPath = [...path, idx];
      wordArr.push(ch);

      if (next.$){
        if (wordArr.length > bestLen){
          bestLen = wordArr.length;
          examples.clear();
          examples.add(wordArr.join(""));
          bestPath = newPath.slice();
        } else if (wordArr.length === bestLen){
          if (examples.size < 5) examples.add(wordArr.join(""));
        }
      }

      const nn = neigh[idx];
      for (let k=0;k<nn.length;k++){
        const j = nn[k];
        if (newMask & (1<<j)) continue;
        dfs(j, next, newMask, wordArr, newPath);
      }

      wordArr.pop();
    }

    for (let i=0;i<16;i++){
      dfs(i, trie, 0, [], []);
    }
    return { maxLen: bestLen, examples: Array.from(examples), path: bestPath };
  }

  function makeBoard(){
    let attempts=0, chosen=null, stats=null;
    while(attempts<250){
      const g = Array.from({length:16}, pick);
      const s = maxOnBoard(g, trie);
      if (s.maxLen>=8 && s.maxLen<=14){
        chosen=g; stats=s; break;
      }
      attempts++;
    }
    if (!chosen){
      chosen = Array.from({length:16}, pick);
      stats = maxOnBoard(chosen, trie);
    }
    return { grid: chosen, stats };
  }

  // ===== UI wiring =====
  const bestlineUpdate = (best,max)=>{
    if (!max || max<=0){ bestline.textContent = ""; closerEl.style.display="none"; return; }
    const pct = Math.round((best/max)*100);
    const medal = pct>=90 ? "ü•á" : (pct>=75 ? "ü•à" : (pct>=60 ? "ü•â" : ""));
    bestline.textContent = `Best ${best} / ${max} (${pct}%) ${medal}`;
    closerEl.style.display = "flex";
    fillEl.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    pctEl.textContent = `${pct}%`;
    medalEl.textContent = medal;
  };

  function renderGrid(){
    gridEl.innerHTML = "";
    grid.forEach((ch, idx)=>{
      const d = document.createElement('div');
      d.className = 'cell';
      d.textContent = ch;
      d.dataset.idx = idx;
      gridEl.appendChild(d);
    });
  }

  const cells = ()=>gridEl.querySelectorAll('.cell');

  function updateSelectionUI(){
    cells().forEach(c=>c.classList.remove('sel'));
    selected.forEach(i=>{
      const c = gridEl.querySelector(`.cell[data-idx="${i}"]`);
      if (c) c.classList.add('sel');
    });
    submitEl.disabled = selected.length < 3 || completed;
  }

  function isNeighbor(a,b){
    const ax=a%4, ay=(a/4)|0, bx=b%4, by=(b/4)|0;
    return Math.max(Math.abs(ax-bx), Math.abs(ay-by)) === 1;
  }

  function shake(el){ el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), 150); }

  let maxLen = 0;
  let examples = [];
  let bestPath = [];
  let busy = false;

  function persist(){ 
    saveState({ 
      day:CURRENT_DAY, grid, attempts, completed, streak, lastPlayedDay, maxLen, examples, dictLabel 
    }, CURRENT_DAY); 
    // Also save streak globally
    localStorage.setItem(KEY('streak'), streak);
    localStorage.setItem(KEY('lastPlayedDay'), lastPlayedDay);
  }

  function initNewDay(){
    const { grid:g, stats } = makeBoard();
    grid = g; maxLen = stats.maxLen; examples = stats.examples; bestPath = stats.path;
    attempts = []; completed=false;
  }

  function initFromStorage(){
    const s = loadState(CURRENT_DAY);
    if (!s.day || s.day !== CURRENT_DAY || !s.grid){
      initNewDay();
      // Load global streak
      streak = parseInt(localStorage.getItem(KEY('streak'))||'0',10);
      lastPlayedDay = parseInt(localStorage.getItem(KEY('lastPlayedDay'))||'0',10);
      persist();
    } else {
      grid = s.grid; attempts = s.attempts || []; completed = !!s.completed;
      streak = parseInt(localStorage.getItem(KEY('streak'))||'0',10);
      lastPlayedDay = parseInt(localStorage.getItem(KEY('lastPlayedDay'))||'0',10);
      maxLen = s.maxLen || 0; examples = s.examples || [];
      if (!maxLen){ const stats = maxOnBoard(grid, trie); maxLen = stats.maxLen; examples = stats.examples; bestPath = stats.path; persist(); }
    }
    document.getElementById('streak').textContent = streak;
    setShots(attempts.length);
    const best = Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len));
    bestlineUpdate(best, maxLen);
    if (completed){ 
      submitEl.disabled = true; 
      shareEl.style.display = "inline-block"; 
      setToast("All shots used. Try archive mode for past puzzles.", "ok"); 
    }
  }

  function showHotspotIfNeeded(){
    cells().forEach(c=>c.classList.remove('hot'));
    if (attempts.length === 2 && bestPath && bestPath.length){
      const pickIdx = bestPath[Math.floor(rngFunc()*bestPath.length)];
      const el = gridEl.querySelector(`.cell[data-idx="${pickIdx}"]`);
      if (el) el.classList.add('hot');
    }
  }

  // ===== Click handlers =====
  gridEl.addEventListener('click', (e)=>{
    const cell = e.target.closest('.cell'); if (!cell || completed || busy) return;
    const idx = parseInt(cell.dataset.idx,10);
    const last = selected[selected.length-1];

    if (selected.length && idx === last){ selected.pop(); updateSelectionUI(); return; }
    if (selected.includes(idx)){ shake(cell); return; }
    if (selected.length === 0 || isNeighbor(last, idx)){ selected.push(idx); updateSelectionUI(); }
    else { shake(cell); }
  });

  submitEl.addEventListener('click', ()=>{
    if (completed || selected.length < 3 || busy) return;
    busy = true;
    
    const word = selected.map(i=>grid[i]).join('').toLowerCase();
    const valid = dictSet.has(word);
    const entry = { word, len: word.length, valid, ts: Date.now() };
    attempts.push(entry);

    // Streak tracking (only for today's puzzle)
    if (CURRENT_DAY === TODAY && attempts.length === 1){
      if (lastPlayedDay == null || lastPlayedDay < TODAY-1) streak = 1;
      else if (lastPlayedDay === TODAY-1) streak = (streak||0) + 1;
      lastPlayedDay = TODAY;
      streakEl.textContent = streak;
    }

    setToast(valid ? `‚úì "${word.toUpperCase()}" (${entry.len})` : `‚úó "${word.toUpperCase()}" not in list`, valid?"ok":"err");

    selected = []; updateSelectionUI();

    const best = Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len));
    bestlineUpdate(best, maxLen);

    if (attempts.length >= 3){
      completed = true; submitEl.disabled = true;
      const ex = examples && examples.length ? ` Example: ${examples[0].toUpperCase()}` : "";
      setToast(`All shots used. Today's max is ${maxLen}.${ex}`, "ok");
      shareEl.style.display = "inline-block";
      
      // Track play completion to Supabase (only for today)
      if (CURRENT_DAY === TODAY) trackPlay();
    }
    setShots(attempts.length);
    persist();
    showHotspotIfNeeded();
    
    busy = false;
  });

  // ===== Share with visual grid =====
  shareEl.addEventListener('click', async ()=>{
    const best = Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len));
    const pct = maxLen ? Math.round((best/maxLen)*100) : 0;
    const medal = pct>=90 ? "ü•á" : (pct>=75 ? "ü•à" : (pct>=60 ? "ü•â" : ""));
    
    // Generate visual grid showing letters used in best word
    const bestAttempt = attempts.filter(a=>a.valid).sort((a,b)=>b.len-a.len)[0];
    const gridViz = grid.map((letter, i) => {
      if (bestAttempt) {
        // Check if this cell was used in the best word's path
        const bestWord = bestAttempt.word.toUpperCase();
        return bestWord.includes(letter) ? letter : '¬∑';
      }
      return '¬∑';
    });
    
    // Format as 4x4 grid
    const gridText = [
      gridViz.slice(0,4).join(' '),
      gridViz.slice(4,8).join(' '),
      gridViz.slice(8,12).join(' '),
      gridViz.slice(12,16).join(' ')
    ].join('\n');
    
    const archiveNote = CURRENT_DAY !== TODAY ? ` (Archive #${CURRENT_DAY})` : '';
    const text = `Longshot #${CURRENT_DAY}${archiveNote}\n${best}/${maxLen} (${pct}%) ${medal}\n\n${gridText}\n\nkapework.com/longshot`;
    
    try{
      if (navigator.share){ await navigator.share({ text }); }
      else {
        await navigator.clipboard.writeText(text);
        setToast("Result copied to clipboard.", "ok");
      }
    }catch(_){}
  });

  // ===== Archive mode =====
  let archiveOpen = false;
  archiveToggleEl.addEventListener('click', ()=>{
    archiveOpen = !archiveOpen;
    archiveEl.style.display = archiveOpen ? 'block' : 'none';
    if (archiveOpen && archiveGridEl.children.length === 0) {
      renderArchive();
    }
  });

  function renderArchive(){
    archiveGridEl.innerHTML = '';
    // Show last 28 days
    for (let i = 27; i >= 0; i--){
      const day = TODAY - i;
      const btn = document.createElement('button');
      btn.className = 'day-btn';
      if (day === CURRENT_DAY) btn.classList.add('current');
      
      // Check if this day has been played
      const dayState = loadState(day);
      if (dayState.attempts && dayState.attempts.length > 0) btn.classList.add('played');
      
      btn.textContent = day === TODAY ? 'Today' : `-${i}`;
      btn.onclick = ()=> loadDay(day);
      archiveGridEl.appendChild(btn);
    }
  }

  function loadDay(day){
    CURRENT_DAY = day;
    rngFunc = mulberry32((CURRENT_DAY ^ 0x9E3779B9) >>> 0); // Regenerate RNG for this day
    document.getElementById('puzzleNum').textContent = `#${CURRENT_DAY}`;
    todayEl.textContent = CURRENT_DAY === TODAY ? 
      new Date().toUTCString().slice(0,16) + " UTC" :
      `Archive: Day ${CURRENT_DAY}`;
    
    selected = [];
    
    // Load state for this day, or generate fresh if corrupted
    const s = loadState(CURRENT_DAY);
    const isValidGrid = (g) => {
      if (!g || !Array.isArray(g) || g.length !== 16) return false;
      if (g.every(c => c === g[0])) return false; // All same = corrupted
      return true;
    };
    
    if (!s.day || s.day !== CURRENT_DAY || !isValidGrid(s.grid)){
      // Reset RNG fresh for this day before generating
      rngFunc = mulberry32((CURRENT_DAY ^ 0x9E3779B9) >>> 0);
      initNewDay();
      persist();
    } else {
      grid = s.grid; 
      attempts = s.attempts || []; 
      completed = !!s.completed;
      maxLen = s.maxLen || 0; 
      examples = s.examples || [];
      bestPath = s.bestPath || [];
      if (!maxLen){ 
        const stats = maxOnBoard(grid, trie); 
        maxLen = stats.maxLen; 
        examples = stats.examples; 
        bestPath = stats.path; 
      }
    }
    
    renderGrid();
    updateSelectionUI();
    setShots(attempts.length);
    const best = Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len));
    bestlineUpdate(best, maxLen);
    if (completed){ 
      submitEl.disabled = true; 
      shareEl.style.display = "inline-block"; 
    }
    showHotspotIfNeeded();
    renderArchive(); // Update archive buttons
  }

  // ===== Supabase tracking =====
  async function trackPlay(){
    try{
      if (!sb) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      await sb.from("plays").insert({ 
        slug: SLUG, 
        device_id: deviceId,
        metadata: { day: CURRENT_DAY, best: Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len)) }
      });
    }catch(e){ 
      console.warn('Could not track play:', e); 
    }
  }

  // ===== Boot =====
  (async function start(){
    setToast("Loading word list‚Ä¶", "muted");
    await loadDictionary();
    setToast(`Loaded ${dictSet.size.toLocaleString()} words.`);
    
    // Initialize Supabase
    try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) {}
    
    const s = loadState(TODAY);
    
    // Validate saved grid - check it has 16 letters and not all the same (corrupted state)
    const isValidGrid = (g) => {
      if (!g || !Array.isArray(g) || g.length !== 16) return false;
      // Check not all same letter (corrupted state detection)
      const allSame = g.every(c => c === g[0]);
      if (allSame) return false;
      return true;
    };
    
    if (!s.day || s.day !== TODAY || !isValidGrid(s.grid)){
      // Reset RNG to ensure fresh start for this day
      rngFunc = mulberry32((TODAY ^ 0x9E3779B9) >>> 0);
      initNewDay(); 
      persist();
    } else {
      if (!s.maxLen){ const stats = maxOnBoard(s.grid, trie); maxLen=stats.maxLen; examples=stats.examples; bestPath=stats.path; }
      else { maxLen=s.maxLen; examples=s.examples||[]; bestPath = s.bestPath || []; }
      grid = s.grid; attempts = s.attempts||[]; completed=!!s.completed; 
      streak=parseInt(localStorage.getItem(KEY('streak'))||'0',10); 
      lastPlayedDay=parseInt(localStorage.getItem(KEY('lastPlayedDay'))||'0',10);
    }
    renderGrid();
    updateSelectionUI();
    
    // Load streak info (don't call full initFromStorage to avoid double init)
    streak = parseInt(localStorage.getItem(KEY('streak'))||'0',10);
    lastPlayedDay = parseInt(localStorage.getItem(KEY('lastPlayedDay'))||'0',10);
    streakEl.textContent = streak;
    setShots(attempts.length);
    const best = Math.max(0, ...attempts.filter(a=>a.valid).map(a=>a.len));
    bestlineUpdate(best, maxLen);
    if (completed){ 
      submitEl.disabled = true; 
      shareEl.style.display = "inline-block"; 
      setToast("All shots used. Today's max is " + maxLen + ".", "ok"); 
    }
    
    showHotspotIfNeeded();
  })();
})();
</script>
</body>
</html>
