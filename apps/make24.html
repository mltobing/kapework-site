<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Make 24</title>
<style>
  :root { --bg:#0b1220; --panel:#121a2c; --ink:#e8eefc; --muted:#93a3c9; --bd:rgba(255,255,255,.08);
          --accent:#7dd3fc; --ok:#34d399; --err:#fb7185; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:560px;margin:0 auto;padding:16px 16px 28px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h1{margin:0;font-size:20px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#0e1729}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .target{display:flex;justify-content:center;margin-bottom:8px}
  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0 12px}
  .card{height:74px;border-radius:14px;border:1px solid var(--bd);background:rgba(255,255,255,.02);
        display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px;
        cursor:pointer;user-select:none;transition:transform .05s ease, background .1s, box-shadow .1s}
  .card:active{transform:scale(.98)}
  .card.sel{outline:2px solid var(--accent);background:rgba(125,211,252,.12)}
  .ops{display:flex;gap:10px;justify-content:center;margin:2px 0 8px}
  .op{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:#e8eefc;cursor:pointer;font:inherit;min-width:52px;text-align:center}
  .op:disabled{opacity:.4;cursor:not-allowed}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:8px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#0e1729;color:#e8eefc;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .tabs{display:flex;gap:8px;justify-content:center;margin:6px 0 2px}
  .tab{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#0e1729;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .status{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-top:8px;gap:8px;flex-wrap:wrap}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .toast{min-height:20px;text-align:center;font-size:14px;margin-top:8px}
  @media(min-width:560px){ .card{height:92px;font-size:30px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Make 24</h1>
    <span class="pill">Target <strong>24</strong></span>
  </header>

  <div class="panel">
    <div class="tabs">
      <button id="tab-daily" class="tab active">Daily <span id="pnum" class="muted"></span></button>
      <button id="tab-practice" class="tab">Practice</button>
    </div>

    <div class="target"><span id="hint" class="pill" style="opacity:.9">Use each number once. Tap two cards, then an operator.</span></div>

    <div id="cards" class="cards" role="group" aria-label="number cards"></div>

    <div class="ops">
      <button class="op" data-op="+">+</button>
      <button class="op" data-op="-">−</button>
      <button class="op" data-op="*">×</button>
      <button class="op" data-op="/">÷</button>
    </div>

    <div class="actions">
      <button id="undo" class="btn" disabled>Undo</button>
      <button id="reset" class="btn">Reset</button>
      <button id="new" class="btn">New</button>
    </div>

    <div class="status">
      <div id="modeLine" class="muted"></div>
      <div id="solvable" class="muted"></div>
    </div>

    <div id="toast" class="toast" aria-live="polite"></div>
  </div>

  <p class="muted" style="margin-top:10px">Each puzzle is solvable and avoids trivial “sum equals 24”. Parentheses are handled automatically—you just combine two cards at a time.</p>
</div>

<script>
(function(){
  // ===== Basics =====
  const TARGET = 24;
  const DAY = Math.floor(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate())/864e5);
  const NS = "make24_v1";
  const KEY = (k)=>`${NS}_${k}`;
  const modeEl = document.getElementById('modeLine');
  const pnumEl = document.getElementById('pnum');
  const toastEl = document.getElementById('toast');
  const solvEl = document.getElementById('solvable');

  const cardsEl = document.getElementById('cards');
  const opsEls = Array.from(document.querySelectorAll('.op'));
  const undoEl = document.getElementById('undo');
  const resetEl = document.getElementById('reset');
  const newEl = document.getElementById('new');
  const tabDaily = document.getElementById('tab-daily');
  const tabPractice = document.getElementById('tab-practice');

  function setToast(msg, cls=""){ toastEl.textContent = msg; toastEl.className = `toast ${cls}`.trim(); }

  // ===== RNG (mulberry32) =====
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }

  // ===== Solver for 24 =====
  // Returns { found:boolean, solutions:[{expr, usedOps:Set<string>}] }
  const EPS = 1e-6;
  function solve24(nums){
    const arr = nums.map(n=>({val:n, expr:String(n)}));
    const sols = [];
    function dfs(items){
      if (items.length===1){
        if (Math.abs(items[0].val - TARGET) < EPS){
          const e = items[0].expr;
          sols.push({expr:e, usedOps:new Set(e.replace(/[0-9(). ]/g,'').split(''))});
        }
        return;
      }
      // pick pairs i<j
      for (let i=0;i<items.length;i++){
        for (let j=i+1;j<items.length;j++){
          const a = items[i], b = items[j];
          const rest = items.filter((_,k)=>k!==i && k!==j);
          const cand = [];

          // + and * (commutative): one order
          cand.push({ val:a.val+b.val, expr:`(${a.expr}+${b.expr})` });
          cand.push({ val:a.val*b.val, expr:`(${a.expr}*${b.expr})` });

          // - and / (both orders)
          cand.push({ val:a.val-b.val, expr:`(${a.expr}-${b.expr})` });
          cand.push({ val:b.val-a.val, expr:`(${b.expr}-${a.expr})` });
          if (Math.abs(b.val) > EPS) cand.push({ val:a.val/b.val, expr:`(${a.expr}/${b.expr})` });
          if (Math.abs(a.val) > EPS) cand.push({ val:b.val/a.val, expr:`(${b.expr}/${a.expr})` });

          for (const c of cand){
            // small pruning: huge magnitudes are unlikely useful
            if (!isFinite(c.val) || Math.abs(c.val)>1e6) continue;
            dfs(rest.concat(c));
          }
        }
      }
    }
    dfs(arr);
    return { found: sols.length>0, solutions: sols };
  }

  // ===== Quality gate =====
  // We accept only if:
  //  1) there exists at least one solution
  //  2) sum of the four != TARGET (avoid trivial a+b+c+d)
  //  3) we can pick a solution that uses '*' or '/' (to avoid "all plus/minus")
  function isGood(nums, solved){
    if (!solved.found) return false;
    const sum = nums.reduce((a,b)=>a+b,0);
    if (sum === TARGET) return false;
    const pick = solved.solutions.find(s => s.usedOps.has('*') || s.usedOps.has('/'));
    return !!pick;
  }

  // ===== Generator =====
  function randomInt(rng, a, b){ return Math.floor(rng()*(b-a+1))+a; }
  function generateSet(rng){
    // classic range 1..10 feels good; 1..9 also common
    return [randomInt(rng,1,10), randomInt(rng,1,10), randomInt(rng,1,10), randomInt(rng,1,10)];
  }
  function makePuzzle(seed){
    const rng = mulberry32(seed>>>0);
    let tries=0;
    while(tries<500){
      const nums = generateSet(rng);
      const solved = solve24(nums);
      if (isGood(nums, solved)){
        // prefer a solution with * or / (we already checked it's available)
        const sol = solved.solutions.find(s => s.usedOps.has('*') || s.usedOps.has('/')) || solved.solutions[0];
        return { nums, solution: sol.expr };
      }
      tries++;
    }
    // Fallback (very rare): return the last set even if not perfect
    const nums = generateSet(rng);
    const solved = solve24(nums);
    return { nums, solution: (solved.found ? solved.solutions[0].expr : "") };
  }

  // ===== Game state =====
  let mode = "daily"; // 'daily' | 'practice'
  let seedDaily = (DAY ^ 0x9E3779B9) >>> 0;
  let seedPractice = (Date.now() ^ 0xA5B35705) >>> 0;

  let original = [];            // the four original numbers
  let items = [];               // current items [{val, expr}] grows/shrinks
  let selected = [];            // selected indices within 'items'
  let history = [];             // stack of previous states (for Undo)
  let solutionExpr = "";        // one example solution (for future “Reveal”)

  // ===== Persistence for daily =====
  function persistDaily(){
    if (mode!=="daily") return;
    const state = {
      day: DAY, original, items,
      history, solutionExpr
    };
    localStorage.setItem(KEY("daily"), JSON.stringify(state));
  }
  function loadDaily(){
    try{
      const s = JSON.parse(localStorage.getItem(KEY("daily"))||"{}");
      if (s.day === DAY && s.original && s.items){
        original = s.original; items = s.items; history = s.history||[]; solutionExpr = s.solutionExpr||"";
        return true;
      }
    }catch(_){}
    return false;
  }

  // ===== UI helpers =====
  function fmt(n){
    // show integers clean; otherwise up to 3 decimals
    const r = Math.round(n*1000)/1000;
    return Math.abs(r - Math.round(r)) < 1e-9 ? String(Math.round(r)) : String(r);
  }
  function render(){
    // header puzzle number
    pnumEl.textContent = `#${DAY}`;
    // mode line
    modeEl.textContent = (mode==="daily" ? "Shared daily puzzle (UTC)" : "Practice mode");
    // cards
    cardsEl.innerHTML = "";
    items.forEach((it, idx)=>{
      const d = document.createElement('div');
      d.className = "card";
      d.textContent = fmt(it.val);
      d.dataset.idx = idx;
      if (selected.includes(idx)) d.classList.add("sel");
      d.addEventListener('click', ()=>{
        if (selected.includes(idx)){
          selected = selected.filter(i=>i!==idx);
        } else {
          if (selected.length<2) selected.push(idx);
          else { selected = [selected[1], idx]; } // keep last + new
        }
        updateOpsState();
        render();
      });
      cardsEl.appendChild(d);
    });
    updateOpsState();
    undoEl.disabled = history.length===0;
  }
  function updateOpsState(){
    const ready = selected.length===2;
    opsEls.forEach(b=> b.disabled = !ready);
  }

  // ===== Operations =====
  function combine(op){
    if (selected.length!==2) return;
    const [a,b] = selected.map(i=>items[i]);
    // compute result
    let val;
    if (op==='+') val = a.val + b.val;
    if (op==='-') val = a.val - b.val;
    if (op==='*') val = a.val * b.val;
    if (op==='/'){ if (Math.abs(b.val)<EPS){ setToast("Cannot divide by zero.", "err"); return; } val = a.val / b.val; }

    // push to history (deep-ish copy)
    history.push({ items: JSON.parse(JSON.stringify(items)) });

    // remove higher index first then lower to keep indices stable
    const i1 = selected[0], i2 = selected[1];
    const hi = Math.max(i1,i2), lo = Math.min(i1,i2);
    items.splice(hi,1);
    items.splice(lo,1);
    items.push({ val, expr:`(${a.expr}${op}${b.expr})` });

    selected = []; render(); checkWin(); if (mode==="daily") persistDaily();
  }

  function checkWin(){
    setToast("");
    if (items.length===1){
      if (Math.abs(items[0].val - TARGET) < EPS){
        setToast("Nice! 24 achieved ✔", "ok");
      }else{
        setToast(`Result ${fmt(items[0].val)} ≠ 24. Try Undo or Reset.`, "err");
      }
    }
  }

  // ===== Controls =====
  opsEls.forEach(btn=>{
    btn.addEventListener('click', ()=> combine(btn.dataset.op));
  });
  undoEl.addEventListener('click', ()=>{
    if (!history.length) return;
    const last = history.pop();
    items = last.items;
    selected = [];
    render(); if (mode==="daily") persistDaily();
  });
  resetEl.addEventListener('click', ()=>{
    items = original.map(n=>({val:n, expr:String(n)}));
    selected = []; history = [];
    render(); setToast(""); if (mode==="daily") persistDaily();
  });
  newEl.addEventListener('click', ()=>{
    if (mode==="daily"){
      // regenerate with the same day seed but “next stream” so daily stays same on each load.
      // We don’t change the daily puzzle from here to keep the shared ritual intact.
      setToast("Daily is fixed. Switch to Practice if you want another.", ""); 
      return;
    }
    seedPractice = (seedPractice + 1) >>> 0;
    startPractice();
  });

  tabDaily.addEventListener('click', ()=>{ if (mode!=="daily"){ mode="daily"; tabDaily.classList.add('active'); tabPractice.classList.remove('active'); startDaily(); }});
  tabPractice.addEventListener('click', ()=>{ if (mode!=="practice"){ mode="practice"; tabPractice.classList.add('active'); tabDaily.classList.remove('active'); startPractice(); }});

  // ===== Booters =====
  function startDaily(){
    setToast("Loading daily…",""); solvEl.textContent = "";
    let loaded = loadDaily();
    if (!loaded){
      const { nums, solution } = makePuzzle((DAY ^ 0x9E3779B9)>>>0);
      original = nums.slice();
      items = original.map(n=>({val:n, expr:String(n)}));
      selected = []; history = []; solutionExpr = solution;
      persistDaily();
    }else{
      // ensure numbers look clean after restore
      items = items.map(it=>({val:it.val, expr:it.expr}));
    }
    render();
    setToast("");
    solvEl.textContent = "Solvable ✓";
  }

  function startPractice(){
    setToast("Loading…",""); solvEl.textContent = "";
    const { nums, solution } = makePuzzle(seedPractice);
    original = nums.slice();
    items = original.map(n=>({val:n, expr:String(n)}));
    selected = []; history = []; solutionExpr = solution;
    render(); setToast(""); solvEl.textContent = "Solvable ✓";
  }

  // Start in daily mode
  startDaily();
})();
</script>
</body>
</html>