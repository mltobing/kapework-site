<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Make 24 — Daily</title>
<style>
  :root{
    --bg:#f7fafc;
    --ink:#0f172a;
    --muted:#64748b;
    --bd:#e5e7eb;
    --panel:#ffffff;
    --shadow:0 1px 3px rgba(15,23,42,.06), 0 10px 24px rgba(15,23,42,.04);
    --accent:#f6c90e;
    --pick:#22d3ee;
    --ok:#16a34a;
    --err:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }

  .wrap{max-width:720px;margin:0 auto;padding:18px 14px 40px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:22px}
  .badge{
    display:inline-flex;gap:8px;align-items:center;
    padding:6px 12px;border:1px solid var(--bd);border-radius:999px;
    background:var(--panel);box-shadow:var(--shadow);font-weight:600
  }
  .muted{color:var(--muted)}

  /* Panel is responsive-square: never taller than viewport, never wider than container */
  .panel{
    position:relative;background:var(--panel);border:1px solid var(--bd);border-radius:16px;
    box-shadow:var(--shadow);overflow:hidden;margin:0 auto;
    /* size rules */
    width:100%;
    max-width:680px;
    /* Square board area computed by CSS aspect-ratio so it fits any phone */
    aspect-ratio: 1 / 1;
  }
  /* faint X */
  .panel::before,.panel::after{
    content:"";position:absolute;inset:12px;border-top:1px solid #f2f3f5;transform-origin:center;pointer-events:none
  }
  .panel::before{transform:rotate(45deg)}
  .panel::after{transform:rotate(-45deg)}

  /* Board grid lives inside a padded square */
  .board{
    position:absolute; inset:14px 14px 82px;  /* bottom space for operators */
    display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr; gap:10px;
  }
  .slot{display:flex;align-items:center;justify-content:center}
  .top{grid-column:2;grid-row:1}
  .left{grid-column:1;grid-row:2}
  .right{grid-column:3;grid-row:2}
  .bottom{grid-column:2;grid-row:3}

  /* Card size is tied to panel with clamp so it never clips */
  .card{
    width:clamp(88px, 24vw, 160px);
    height:clamp(66px, 16vw, 120px);
    border-radius:14px;border:1px solid var(--bd);background:var(--panel);box-shadow:var(--shadow);
    display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size:clamp(24px,6vw,40px);
    cursor:pointer; user-select:none;
    transition:transform .06s, outline-color .12s, background .12s
  }
  .card:active{transform:scale(.985)}
  .card.sel{outline:3px solid var(--pick); outline-offset:2px; background:#ecfeff}
  .faded{opacity:.35}

  /* Operators anchored inside the panel, never overlapping content */
  .ops{
    position:absolute; left:0; right:0; bottom:12px;
    display:flex; gap:10px; justify-content:center; padding:0 10px;
  }
  .op{
    padding:12px 18px; min-width:58px; font:700 18px/1 inherit;
    border-radius:12px; border:1px solid var(--bd); background:var(--panel); box-shadow:var(--shadow); cursor:pointer;
  }
  .op:disabled{opacity:.4;cursor:not-allowed}

  .row{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .btn{padding:10px 16px;border-radius:12px;border:1px solid var(--bd);background:var(--panel);box-shadow:var(--shadow);cursor:pointer;font-weight:600}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .status{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-top:10px}
  .shots{letter-spacing:2px}
  .toast{min-height:24px;text-align:center;font-size:15px;margin-top:12px;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow)}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .pulse{animation:pulse .25s ease}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
  .shake{animation:shake .15s}

  /* Confetti canvas overlays panel bounds */
  #confetti{position:absolute; inset:0; pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Make 24 <span id="pnum" class="muted"></span></h1>
    <span class="badge">Attempts <strong id="tries">0/4</strong></span>
  </header>

  <div class="panel" id="panel">
    <canvas id="confetti" width="1" height="1"></canvas>

    <div class="board">
      <div class="slot top"><div class="card" data-pos="top"></div></div>
      <div class="slot left"><div class="card" data-pos="left"></div></div>
      <div class="slot right"><div class="card" data-pos="right"></div></div>
      <div class="slot bottom"><div class="card" data-pos="bottom"></div></div>
    </div>

    <div class="ops">
      <button class="op" data-op="+">+</button>
      <button class="op" data-op="/">÷</button>
      <button class="op" data-op="*">×</button>
      <button class="op" data-op="-">−</button>
    </div>
  </div>

  <div class="row">
    <button id="undo"  class="btn" disabled>Undo</button>
    <button id="reset" class="btn">Reset</button>
    <button id="share" class="btn" style="display:none">Share</button>
  </div>

  <div class="status">
    <div id="modeLine" class="muted">Daily puzzle · Target 24</div>
    <div id="shots" class="shots">● ○ ○ ○</div>
    <div id="scoreline" class="muted"></div>
  </div>

  <div id="toast" class="toast muted" aria-live="polite"></div>

  <p class="muted" style="margin-top:12px">
    Tap two numbers, then an operator. Use each original number exactly once. When one card remains, your attempt is logged automatically.
  </p>
</div>

<script>
(function(){
  const TARGET=24, MAX_TRIES=4, EPS=1e-6;
  const DAY=Math.floor(Date.UTC(new Date().getUTCFullYear(),new Date().getUTCMonth(),new Date().getUTCDate())/864e5);
  const NS="make24_daily_v4"; const KEY=k=>`${NS}_${k}`;

  const pnum=document.getElementById('pnum'); pnum.textContent=`#${DAY}`;
  const panel=document.getElementById('panel');
  const canvas=document.getElementById('confetti'); const ctx=canvas.getContext('2d');

  const cardsDom=[...document.querySelectorAll('.card')];
  const opsDom=[...document.querySelectorAll('.op')];
  const undoEl=document.getElementById('undo');
  const resetEl=document.getElementById('reset');
  const shareEl=document.getElementById('share');
  const toastEl=document.getElementById('toast');
  const triesEl=document.getElementById('tries');
  const shotsEl=document.getElementById('shots');
  const scoreline=document.getElementById('scoreline');

  const setToast=(m,cls="muted")=>{toastEl.textContent=m;toastEl.className=`toast ${cls}`;}
  const fmt=n=>{const r=Math.round(n*1000)/1000;return Math.abs(r-Math.round(r))<1e-9?String(Math.round(r)):String(r);}
  const mulberry32=a=>()=>{let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}
  const rng=mulberry32((DAY^0x9E3779B9)>>>0);
  const ri=(a,b)=>Math.floor(rng()*(b-a+1))+a;

  /* ---------- Confetti ---------- */
  function resizeConfetti(){
    const rect=panel.getBoundingClientRect();
    canvas.width=rect.width; canvas.height=rect.height;
  }
  window.addEventListener('resize', resizeConfetti);
  resizeConfetti();

  function confettiBurst(){
    resizeConfetti();
    const pieces=[];
    const colors=['#22d3ee','#f6c90e','#34d399','#60a5fa','#fb7185'];
    for(let i=0;i<120;i++){
      pieces.push({
        x: canvas.width/2, y: canvas.height/3,
        vx: (Math.random()*2-1)*4, vy: -Math.random()*4-2,
        g: 0.08+Math.random()*0.04,
        w: 4+Math.random()*3, h: 8+Math.random()*4,
        r: Math.random()*Math.PI,
        vr: (Math.random()*2-1)*0.2,
        c: colors[i%colors.length], a:1
      });
    }
    let t=0;
    function tick(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=p.vr; p.a*=0.995;
        ctx.save(); ctx.globalAlpha=Math.max(0,p.a);
        ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle=p.c; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        ctx.restore();
      });
      t++;
      if(t<220) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    tick();
  }

  /* ---------- Solver & Puzzle ---------- */
  function solve24(nums){
    const arr=nums.map(n=>({val:n,expr:String(n)})); const sols=[];
    function dfs(items){
      if(items.length===1){
        if(Math.abs(items[0].val-TARGET)<EPS){
          const e=items[0].expr; sols.push({expr:e,usedOps:new Set(e.replace(/[0-9(). ]/g,'').split(''))});
        } return;
      }
      for(let i=0;i<items.length;i++){
        for(let j=i+1;j<items.length;j++){
          const a=items[i], b=items[j], rest=items.filter((_,k)=>k!==i&&k!==j), cand=[];
          cand.push({val:a.val+b.val,expr:`(${a.expr}+${b.expr})`});
          cand.push({val:a.val*b.val,expr:`(${a.expr}*${b.expr})`});
          cand.push({val:a.val-b.val,expr:`(${a.expr}-${b.expr})`});
          cand.push({val:b.val-a.val,expr:`(${b.expr}-${a.expr})`});
          if(Math.abs(b.val)>EPS)cand.push({val:a.val/b.val,expr:`(${a.expr}/${b.expr})`});
          if(Math.abs(a.val)>EPS)cand.push({val:b.val/a.val,expr:`(${b.expr}/${a.expr})`});
          for(const c of cand){ if(isFinite(c.val)&&Math.abs(c.val)<1e6) dfs(rest.concat(c)); }
        }
      }
    }
    dfs(arr); return {found:sols.length>0,solutions:sols};
  }
  function isGood(nums,solved){
    if(!solved.found) return false;
    if(nums.reduce((a,b)=>a+b,0)===TARGET) return false;
    return !!solved.solutions.find(s=>s.usedOps.has('*')||s.usedOps.has('/'));
  }
  function makePuzzle(seed){
    const r=mulberry32(seed>>>0); let tries=0;
    while(tries<500){
      const nums=[1,1,1,1].map(()=>Math.floor(r()*10)+1);
      const solved=solve24(nums);
      if(isGood(nums,solved)){
        const sol=solved.solutions.find(s=>s.usedOps.has('*')||s.usedOps.has('/'))||solved.solutions[0];
        return {nums,solution:sol.expr};
      } tries++;
    }
    const nums=[ri(1,10),ri(1,10),ri(1,10),ri(1,10)]; const solved=solve24(nums);
    return {nums,solution: solved.found? solved.solutions[0].expr : ""};
  }

  /* ---------- Game State ---------- */
  let original=[], items=[], posOrder=['top','left','right','bottom'];
  let history=[], selectedIdx=[], tries=0, done=false, solutionExpr="", bestValue=null;

  const save=()=>localStorage.setItem(KEY("daily"),JSON.stringify({day:DAY,original,items,history,selectedIdx,tries,done,solutionExpr,bestValue}));
  function load(){ try{const s=JSON.parse(localStorage.getItem(KEY("daily"))||"{}"); if(s.day===DAY) return s;}catch(_){} return null; }
  const setCardsFromOriginal=()=>{ items=original.map(n=>({val:n,expr:String(n)})); };

  function render(){
    const map={}; for(let i=0;i<posOrder.length;i++){ map[posOrder[i]]=items[i]??null; }
    cardsDom.forEach(card=>{
      const data=map[card.dataset.pos];
      if(data){ card.textContent=fmt(data.val); card.classList.toggle('faded',false); card.classList.toggle('sel', selectedIdx.includes(items.indexOf(data))); }
      else{ card.textContent=""; card.classList.add('faded'); card.classList.remove('sel'); }
    });
    const ready=selectedIdx.length===2 && !done; opsDom.forEach(o=>o.disabled=!ready);
    undoEl.disabled = history.length===0 || done;
    resetEl.disabled= done;

    triesEl.textContent=`${tries}/${MAX_TRIES}`;
    const dots=["●","○","○","○"]; if(tries>=2)dots[1]="●"; if(tries>=3)dots[2]="●"; if(tries>=4)dots[3]="●"; shotsEl.textContent=dots.join(" ");
  }

  function closenessText(v){
    const pct=Math.round((Math.min(v,TARGET)/TARGET)*100);
    const medal=pct>=100?"🏆":(pct>=90?"🥇":(pct>=75?"🥈":(pct>=60?"🥉":"")));
    if(bestValue!=null){
      const bp=Math.round((Math.min(bestValue,TARGET)/TARGET)*100);
      const bm=bp>=100?"🏆":(bp>=90?"🥇":(bp>=75?"🥈":(bp>=60?"🥉":"")));
      scoreline.textContent=`Best ${fmt(bestValue)} / ${TARGET} (${bp}%) ${bm}`;
    }
    return `Result ${fmt(v)} / ${TARGET} (${pct}%) ${medal}`;
  }

  function endText(){
    const ex = solutionExpr ? ` · Example: ${solutionExpr.replaceAll('*','×').replaceAll('/','÷')}` : "";
    return `All attempts used. Come back tomorrow.${ex}`;
  }

  function autoSubmitIfSingle(){
    if(done || items.length!==1) return;
    const val=items[0].val; bestValue = (bestValue==null)? val : Math.max(bestValue,val);
    tries++; panel.classList.add('pulse');

    if(Math.abs(val-TARGET)<EPS){
      done=true; setToast(`Perfect! ${closenessText(val)} ✔`,"ok"); shareEl.style.display="inline-block"; confettiBurst();
    } else {
      setToast(closenessText(val), "err");
      if(tries<MAX_TRIES){ setCardsFromOriginal(); history=[]; selectedIdx=[]; }
      else { done=true; setToast(endText(),"ok"); shareEl.style.display="inline-block"; }
    }
    render(); save();
    setTimeout(()=>panel.classList.remove('pulse'),220);
  }

  /* ---------- Interaction ---------- */
  cardsDom.forEach(card=>{
    card.addEventListener('click', ()=>{
      if(done) return;
      const idx=posOrder.indexOf(card.dataset.pos);
      if(!items[idx]){ card.classList.add('shake'); setTimeout(()=>card.classList.remove('shake'),150); return; }
      const inv=selectedIdx.indexOf(idx);
      if(inv>=0) selectedIdx.splice(inv,1);
      else { if(selectedIdx.length<2) selectedIdx.push(idx); else selectedIdx=[selectedIdx[1],idx]; }
      render(); save();
    });
  });

  function combine(op){
    if(done || selectedIdx.length!==2) return;
    const i=selectedIdx[0], j=selectedIdx[1]; const a=items[i], b=items[j]; if(!a||!b) return;
    let val;
    if(op==='+') val=a.val+b.val;
    else if(op==='-') val=a.val-b.val;
    else if(op==='*') val=a.val*b.val;
    else if(op==='/'){ if(Math.abs(b.val)<EPS){ setToast("Cannot divide by zero.","err"); return; } val=a.val/b.val; }

    history.push(JSON.parse(JSON.stringify(items)));
    const hi=Math.max(i,j), lo=Math.min(i,j); items.splice(hi,1); items.splice(lo,1);
    const free=posOrder.map((_,k)=>items[k]?null:k).filter(x=>x!==null);
    const slot=free.length?free[0]:items.length;
    items.splice(slot,0,{val,expr:`(${a.expr}${op}${b.expr})`});

    selectedIdx=[]; render(); save();
    if(items.length===1) autoSubmitIfSingle();
  }
  opsDom.forEach(btn=>btn.addEventListener('click',()=>combine(btn.dataset.op)));

  undoEl.addEventListener('click', ()=>{
    if(!history.length || done) return;
    items=history.pop(); selectedIdx=[]; setToast(""); render(); save();
  });
  resetEl.addEventListener('click', ()=>{
    if(done) return;
    setCardsFromOriginal(); history=[]; selectedIdx=[]; setToast(""); render(); save();
  });

  shareEl.addEventListener('click', async ()=>{
    const pct = (bestValue!=null) ? Math.round((Math.min(bestValue,TARGET)/TARGET)*100) : 0;
    const medal=pct>=100?"🏆":(pct>=90?"🥇":(pct>=75?"🥈":(pct>=60?"🥉":"")));
    const text=`Make 24 #${DAY} — ${tries}/${MAX_TRIES} tries · Best ${bestValue!=null?fmt(bestValue):"–"}/${TARGET} (${pct}%) ${medal} [${original.join(", ")}]`;
    try{ if(navigator.share){ await navigator.share({ text }); } else { await navigator.clipboard.writeText(text); setToast("Result copied to clipboard.","ok"); } }
    catch(_){}
  });

  /* ---------- Boot ---------- */
  function initNewDay(){
    const {nums,solution}=makePuzzle((DAY^0x9E3779B9)>>>0);
    original=[nums[0],nums[1],nums[2],nums[3]]; solutionExpr=solution;
    items=original.map(n=>({val:n,expr:String(n)}));
    history=[]; selectedIdx=[]; tries=0; done=false; bestValue=null;
  }
  function start(){
    const s=load();
    if(s){ ({original,items,history,selectedIdx,tries,done,solutionExpr,bestValue}=s); }
    else { initNewDay(); save(); }
    render();
    if(done){ setToast(endText(),"ok"); shareEl.style.display="inline-block"; } else { setToast(""); shareEl.style.display="none"; }
  }
  start();

  // keep fit after orientation change
  window.addEventListener('orientationchange', ()=> setTimeout(resizeConfetti, 250));
})();
</script>
</body>
</html>